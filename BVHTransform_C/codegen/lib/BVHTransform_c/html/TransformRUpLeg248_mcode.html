<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,485" id="srcline485">485</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,486" id="srcline486">486</a></span><span class="line"><span class="comment">%% RUpLeg</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,487" id="srcline487">487</a></span><span class="line"><span class="comment">% HipYawPitch：左右大腿的 HipYawPitch Angle  [ 1*Nframes ]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,488" id="srcline488">488</a></span><span class="line"><span class="keyword">function</span> [ <span class="var type1" id="S482T3U2474">RHipRoll</span>,<span class="var type1" id="S483T3U2475">RHipPitch</span>,<span class="var type1" id="S484T7U2476">RightUpLeg_new</span> ] = TransformRUpLeg( <span class="var type1" id="S485T18U2479">C_Hip_RUpLeg</span>,<span class="var type1" id="S486T3U2480">HipYawPitch</span>,<span class="var type1" id="S487T3U2481">rotateOrder_BVH</span> )</span></span>
<span class="srcline"><span class="lineno"><a href="1,489" id="srcline489">489</a></span><span class="line"><span class="mxinfo" id="T18:U7"><span class="var type1" id="S488T18U2484">C_RUpLeg_Hip</span> = <span class="mxinfo" id="T18:U9"><span class="fcn" id="F78N13:B2486">InverseC_Multi</span>( <span class="var type1" id="S485T18U2487">C_Hip_RUpLeg</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,490" id="srcline490">490</a></span><span class="line"><span class="mxinfo" id="T7:U11"><span class="var type1" id="S490T7U2490">AxisR</span> = <span class="mxinfo" id="T7:U13">[1,1,0]</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,491" id="srcline491">491</a></span><span class="line"><span class="mxinfo" id="T7:U14"><span class="var type1" id="S490T7U2498">AxisR</span> = <span class="mxinfo" id="T7:U16"><span class="var type1" id="S490T7U2500">AxisR</span>/normest(<span class="var type1" id="S490T7U2503">AxisR</span>)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,492" id="srcline492">492</a></span><span class="line"><span class="mxinfo" id="T3:U19"><span class="var type1" id="S492T3U2506">Nframes</span> = <span class="mxinfo" id="T3:U21">size(<span class="var type1" id="S485T18U2509">C_Hip_RUpLeg</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,493" id="srcline493">493</a></span><span class="line"><span class="mxinfo" id="T18:U23"><span class="var type1" id="S494T18U2513">C_HipYawPitch</span> = <span class="mxinfo" id="T18:U25">zeros(<span class="mxinfo" id="T3:U26"><span class="var type1" id="S492T3U2516">Nframes</span></span>,<span class="mxinfo" id="T3:U28">3</span>,<span class="mxinfo" id="T3:U29">3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,494" id="srcline494">494</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S496T3U2521">k</span>=<span class="mxinfo" id="T3:U31">1:<span class="var type1" id="S492T3U2524">Nframes</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,495" id="srcline495">495</a></span><span class="line">    <span class="mxinfo" id="T3:U33"><span class="var type1" id="S497T3U2527">HipYawPitch_k</span> = <span class="var type1" id="S486T3U2529">HipYawPitch</span>(<span class="var type1" id="S496T3U2530">k</span>)</span>;   </span></span>
<span class="srcline"><span class="lineno"><a href="1,496" id="srcline496">496</a></span><span class="line">    <span class="mxinfo" id="T7:U37"><span class="var type1" id="S498T7U2533">Q_AxisR</span> = <span class="mxinfo" id="T7:U39"><span class="mxinfo" id="T7:U40"><span class="var type1" id="S490T7U2535">AxisR</span></span>*<span class="mxinfo" id="T3:U42">sin( <span class="mxinfo" id="T3:U43"><span class="var type1" id="S497T3U2539">HipYawPitch_k</span>/<span class="mxinfo" id="T3:U45">2</span></span> )</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,497" id="srcline497">497</a></span><span class="line">    <span class="mxinfo" id="T37:U46"><span class="var type1" id="S500T37U2543">Q_HipYawPitch_k</span> = <span class="mxinfo" id="T37:U48">[ <span class="mxinfo" id="T3:U49">cos( <span class="mxinfo" id="T3:U50"><span class="var type1" id="S497T3U2549">HipYawPitch_k</span>/<span class="mxinfo" id="T3:U52">2</span></span> )</span> <span class="var type1" id="S498T7U2551">Q_AxisR</span> ]</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,498" id="srcline498">498</a></span><span class="line">    <span class="mxinfo" id="T18:U54"><span class="mxinfo" id="T18:U55"><span class="var type1" id="S494T18U2555">C_HipYawPitch</span>(<span class="mxinfo" id="T3:U57"><span class="var type1" id="S496T3U2556">k</span></span>,:,:)</span> = <span class="mxinfo" id="T13:U59"><span class="fcn" id="F207N12:B2560">FQtoCnb</span>( <span class="var type1" id="S500T37U2561">Q_HipYawPitch_k</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,499" id="srcline499">499</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,500" id="srcline500">500</a></span><span class="line"><span class="mxinfo" id="T18:U61"><span class="var type1" id="S503T18U2564">C_RUpLeg_SecondHip</span> = <span class="mxinfo" id="T18:U63"><span class="fcn" id="F75N5:B2566">CalculateC_Multi</span>( <span class="var type1" id="S488T18U2567">C_RUpLeg_Hip</span>,<span class="var type1" id="S494T18U2568">C_HipYawPitch</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,501" id="srcline501">501</a></span><span class="line"><span class="mxinfo" id="T18:U66"><span class="var type1" id="S503T18U2571">C_RUpLeg_SecondHip</span> = <span class="var type1" id="S488T18U2572">C_RUpLeg_Hip</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,502" id="srcline502">502</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,503" id="srcline503">503</a></span><span class="line"><span class="mxinfo" id="T3:U69"><span class="var type1" id="S483T3U2575">RHipPitch</span> = <span class="mxinfo" id="T3:U71">zeros(1,<span class="var type1" id="S492T3U2579">Nframes</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,504" id="srcline504">504</a></span><span class="line"><span class="mxinfo" id="T3:U73"><span class="var type1" id="S482T3U2582">RHipRoll</span> = <span class="mxinfo" id="T3:U75">zeros(1,<span class="var type1" id="S492T3U2586">Nframes</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,505" id="srcline505">505</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S496T3U2589">k</span>=<span class="mxinfo" id="T3:U78">1:<span class="var type1" id="S492T3U2592">Nframes</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,506" id="srcline506">506</a></span><span class="line">    <span class="mxinfo" id="T13:U80"><span class="var type1" id="S505T13U2595">C_RUpLeg_SecondHip_k</span> = <span class="mxinfo" id="T13:U82">permute( <span class="mxinfo" id="T18:U83"><span class="var type1" id="S503T18U2599">C_RUpLeg_SecondHip</span>(<span class="mxinfo" id="T3:U85"><span class="var type1" id="S496T3U2600">k</span></span>,:,:)</span>,[2,3,1] )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,507" id="srcline507">507</a></span><span class="line">    <span class="mxinfo" id="T3:U87">[<span class="var type1" id="S507T3U2611">x</span>,<span class="var type1" id="S508T3U2612">y</span>,<span class="var type1" id="S509T3U2613">z</span>] = deal( <span class="mxinfo" id="T3:U91"><span class="var type1" id="S505T13U2617">C_RUpLeg_SecondHip_k</span>(<span class="mxinfo" id="T3:U93">1</span>,<span class="mxinfo" id="T3:U94">2</span>)</span>,<span class="mxinfo" id="T3:U95"><span class="var type1" id="S505T13U2621">C_RUpLeg_SecondHip_k</span>(<span class="mxinfo" id="T3:U97">2</span>,<span class="mxinfo" id="T3:U98">2</span>)</span>,<span class="mxinfo" id="T3:U99"><span class="var type1" id="S505T13U2625">C_RUpLeg_SecondHip_k</span>(<span class="mxinfo" id="T3:U101">3</span>,<span class="mxinfo" id="T3:U102">2</span>)</span> )</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,508" id="srcline508">508</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,509" id="srcline509">509</a></span><span class="line">    <span class="mxinfo" id="T3:U103"><span class="var type1" id="S483T3U2631">RHipPitch</span>(<span class="var type1" id="S496T3U2632">k</span>) = <span class="mxinfo" id="T3:U106">asin( <span class="var type1" id="S509T3U2635">z</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,510" id="srcline510">510</a></span><span class="line">    <span class="mxinfo" id="T3:U108"><span class="var type1" id="S482T3U2639">RHipRoll</span>(<span class="var type1" id="S496T3U2640">k</span>) = <span class="mxinfo" id="T3:U111">atan( <span class="mxinfo" id="T3:U112"><span class="mxinfo" id="T3:U113">-<span class="var type1" id="S507T3U2645">x</span></span>/<span class="var type1" id="S508T3U2646">y</span></span> )</span></span>;    </span></span>
<span class="srcline"><span class="lineno"><a href="1,511" id="srcline511">511</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,512" id="srcline512">512</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,513" id="srcline513">513</a></span><span class="line"><span class="mxinfo" id="T7:U116"><span class="var type1" id="S513T7U2649">E_Hip_RUpLeg_ZXY</span> = <span class="mxinfo" id="T7:U118">[ <span class="var type1" id="S482T3U2653">RHipRoll</span>' <span class="var type1" id="S483T3U2655">RHipPitch</span>' <span class="mxinfo" id="T3:U121">zeros(<span class="var type1" id="S492T3U2658">Nframes</span>,1)</span> ]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,514" id="srcline514">514</a></span><span class="line"><span class="mxinfo" id="T18:U123"><span class="var type1" id="S514T18U2662">C_Hip_RUpLeg_ZXY</span> = <span class="mxinfo" id="T18:U125"><span class="fcn" id="F45N11:B2664">EulerToC_c</span>( <span class="var type1" id="S513T7U2665">E_Hip_RUpLeg_ZXY</span>,<span class="mxinfo" id="T3:U127">312</span>,<span class="mxinfo" id="T7:U128">[1,1,1]</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,515" id="srcline515">515</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,516" id="srcline516">516</a></span><span class="line"><span class="mxinfo" id="T27:U129"><span class="var type1" id="S516T27U2674">pos</span> = <span class="mxinfo" id="T27:U131">zeros( <span class="mxinfo" id="T3:U132">3</span>,<span class="var type1" id="S492T3U2678">Nframes</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,517" id="srcline517">517</a></span><span class="line"><span class="mxinfo" id="T27:U134"><span class="var type1" id="S517T27U2681">posNew</span> = <span class="mxinfo" id="T27:U136">zeros( <span class="mxinfo" id="T3:U137">3</span>,<span class="var type1" id="S492T3U2685">Nframes</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,518" id="srcline518">518</a></span><span class="line"><span class="mxinfo" id="T27:U139"><span class="var type1" id="S518T27U2688">pos_err</span> = <span class="mxinfo" id="T27:U141">zeros( <span class="mxinfo" id="T3:U142">3</span>,<span class="var type1" id="S492T3U2692">Nframes</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,519" id="srcline519">519</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S496T3U2695">k</span>=<span class="mxinfo" id="T3:U145">1:<span class="var type1" id="S492T3U2698">Nframes</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,520" id="srcline520">520</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,521" id="srcline521">521</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,522" id="srcline522">522</a></span><span class="line">    <span class="mxinfo" id="T13:U147"><span class="var type1" id="S505T13U2701">C_RUpLeg_SecondHip_k</span> = <span class="mxinfo" id="T13:U149">permute( <span class="mxinfo" id="T18:U150"><span class="var type1" id="S503T18U2705">C_RUpLeg_SecondHip</span>(<span class="mxinfo" id="T3:U152"><span class="var type1" id="S496T3U2706">k</span></span>,:,:)</span>,[2 3 1] )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,523" id="srcline523">523</a></span><span class="line">    <span class="mxinfo" id="T13:U154"><span class="var type1" id="S519T13U2716">C_Hip_RUpLeg_ZXY_k</span> = <span class="mxinfo" id="T13:U156">permute( <span class="mxinfo" id="T18:U157"><span class="var type1" id="S514T18U2720">C_Hip_RUpLeg_ZXY</span>(<span class="mxinfo" id="T3:U159"><span class="var type1" id="S496T3U2721">k</span></span>,:,:)</span>,[2 3 1] )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,524" id="srcline524">524</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,525" id="srcline525">525</a></span><span class="line">    <span class="mxinfo" id="T27:U161"><span class="mxinfo" id="T27:U162"><span class="var type1" id="S516T27U2732">pos</span>(:,<span class="mxinfo" id="T3:U164"><span class="var type1" id="S496T3U2734">k</span></span>)</span> = <span class="mxinfo" id="T27:U166"><span class="var type1" id="S505T13U2736">C_RUpLeg_SecondHip_k</span>*<span class="mxinfo" id="T27:U168">[0;1;0]</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,526" id="srcline526">526</a></span><span class="line">    <span class="mxinfo" id="T27:U169"><span class="mxinfo" id="T27:U170"><span class="var type1" id="S517T27U2747">posNew</span>(:,<span class="mxinfo" id="T3:U172"><span class="var type1" id="S496T3U2749">k</span></span>)</span> = <span class="mxinfo" id="T27:U174"><span class="mxinfo" id="T13:U175"><span class="var type1" id="S519T13U2752">C_Hip_RUpLeg_ZXY_k</span>'</span>*<span class="mxinfo" id="T27:U177">[0;1;0]</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,527" id="srcline527">527</a></span><span class="line">    <span class="mxinfo" id="T27:U178"><span class="mxinfo" id="T27:U179"><span class="var type1" id="S518T27U2763">pos_err</span>(:,<span class="mxinfo" id="T3:U181"><span class="var type1" id="S496T3U2765">k</span></span>)</span> = <span class="mxinfo" id="T27:U183"><span class="mxinfo" id="T27:U184"><span class="var type1" id="S516T27U2768">pos</span>(:,<span class="mxinfo" id="T3:U186"><span class="var type1" id="S496T3U2770">k</span></span>)</span>-<span class="mxinfo" id="T27:U188"><span class="var type1" id="S517T27U2772">posNew</span>(:,<span class="mxinfo" id="T3:U190"><span class="var type1" id="S496T3U2774">k</span></span>)</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,528" id="srcline528">528</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,529" id="srcline529">529</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,530" id="srcline530">530</a></span><span class="line"><span class="mxinfo" id="T3:U192"><span class="var type1" id="S520T3U2777">pos_err_sum</span> = <span class="mxinfo" id="T3:U194">sum( <span class="mxinfo" id="T3:U195">sum( <span class="mxinfo" id="T27:U196">abs( <span class="var type1" id="S518T27U2784">pos_err</span> )</span> )</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,531" id="srcline531">531</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T4:U198"><span class="var type1" id="S520T3U2788">pos_err_sum</span>&gt;<span class="mxinfo" id="T3:U200">1e-1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,532" id="srcline532">532</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S496T3U2792">k</span>=<span class="mxinfo" id="T3:U202">1:<span class="var type1" id="S492T3U2795">Nframes</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,533" id="srcline533">533</a></span><span class="line">        <span class="mxinfo" id="T3:U204"><span class="var type1" id="S483T3U2799">RHipPitch</span>(<span class="var type1" id="S496T3U2800">k</span>) = <span class="mxinfo" id="T3:U207"><span class="mxinfo" id="T3:U208">pi</span>-<span class="var type1" id="S483T3U2805">RHipPitch</span>(<span class="var type1" id="S496T3U2806">k</span>)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,534" id="srcline534">534</a></span><span class="line">    <span class="keyword">end</span>    </span></span>
<span class="srcline"><span class="lineno"><a href="1,535" id="srcline535">535</a></span><span class="line">    <span class="mxinfo" id="T7:U211"><span class="var type1" id="S513T7U2809">E_Hip_RUpLeg_ZXY</span> = <span class="mxinfo" id="T7:U213">[ <span class="var type1" id="S482T3U2813">RHipRoll</span>' <span class="var type1" id="S483T3U2815">RHipPitch</span>' <span class="mxinfo" id="T3:U216">zeros(<span class="var type1" id="S492T3U2818">Nframes</span>,1)</span> ]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,536" id="srcline536">536</a></span><span class="line">    <span class="mxinfo" id="T18:U218"><span class="var type1" id="S514T18U2822">C_Hip_RUpLeg_ZXY</span> = <span class="mxinfo" id="T18:U220"><span class="fcn" id="F45N11:B2824">EulerToC_c</span>( <span class="var type1" id="S513T7U2825">E_Hip_RUpLeg_ZXY</span>,<span class="mxinfo" id="T3:U222">312</span>,<span class="mxinfo" id="T7:U223">[1,1,1]</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,537" id="srcline537">537</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,538" id="srcline538">538</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,539" id="srcline539">539</a></span><span class="line"><span class="comment">%%% get new BVH</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,540" id="srcline540">540</a></span><span class="line"><span class="mxinfo" id="T7:U224"><span class="var type1" id="S484T7U2834">RightUpLeg_new</span> = <span class="mxinfo" id="T7:U226"><span class="fcn" id="F96N4:B2836">CToEuler_c</span>( <span class="var type1" id="S514T18U2837">C_Hip_RUpLeg_ZXY</span>,<span class="var type1" id="S487T3U2838">rotateOrder_BVH</span>,<span class="mxinfo" id="T7:U229">[1,1,1]</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,541" id="srcline541">541</a></span><span class="line"></span></span>
</pre>
