<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,548" id="srcline548">548</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,549" id="srcline549">549</a></span><span class="line"><span class="comment">%% LUpLeg</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,550" id="srcline550">550</a></span><span class="line"><span class="comment">% HipYawPitch：左右大腿的 HipYawPitch Angle  [ Nframes*1 ]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,551" id="srcline551">551</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,552" id="srcline552">552</a></span><span class="line"><span class="keyword">function</span> [ <span class="var type1" id="S532T3U2873">LHipRoll</span>,<span class="var type1" id="S533T3U2874">LHipPitch</span>,<span class="var type1" id="S534T7U2875">LeftUpLeg_new</span> ] = TransformLUpLeg( <span class="var type1" id="S535T18U2878">C_Hip_LUpLeg</span>,<span class="var type1" id="S536T3U2879">HipYawPitch</span>,<span class="var type1" id="S537T3U2880">rotateOrder_BVH</span> )</span></span>
<span class="srcline"><span class="lineno"><a href="1,553" id="srcline553">553</a></span><span class="line"><span class="mxinfo" id="T18:U7"><span class="var type1" id="S538T18U2883">C_LUpLeg_Hip</span> = <span class="mxinfo" id="T18:U9"><span class="fcn" id="F78N13:B2885">InverseC_Multi</span>( <span class="var type1" id="S535T18U2886">C_Hip_LUpLeg</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,554" id="srcline554">554</a></span><span class="line"><span class="mxinfo" id="T7:U11"><span class="var type1" id="S540T7U2889">AxisL</span> = <span class="mxinfo" id="T7:U13">[1,-1,0]</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,555" id="srcline555">555</a></span><span class="line"><span class="mxinfo" id="T7:U14"><span class="var type1" id="S540T7U2898">AxisL</span> = <span class="mxinfo" id="T7:U16"><span class="var type1" id="S540T7U2900">AxisL</span>/normest(<span class="var type1" id="S540T7U2903">AxisL</span>)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,556" id="srcline556">556</a></span><span class="line"><span class="mxinfo" id="T3:U19"><span class="var type1" id="S542T3U2906">Nframes</span> = <span class="mxinfo" id="T3:U21">size(<span class="var type1" id="S535T18U2909">C_Hip_LUpLeg</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,557" id="srcline557">557</a></span><span class="line"><span class="mxinfo" id="T18:U23"><span class="var type1" id="S544T18U2913">C_HipYawPitch</span> = <span class="mxinfo" id="T18:U25">zeros(<span class="mxinfo" id="T3:U26"><span class="var type1" id="S542T3U2916">Nframes</span></span>,<span class="mxinfo" id="T3:U28">3</span>,<span class="mxinfo" id="T3:U29">3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,558" id="srcline558">558</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S546T3U2921">k</span>=<span class="mxinfo" id="T3:U31">1:<span class="var type1" id="S542T3U2924">Nframes</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,559" id="srcline559">559</a></span><span class="line">    <span class="mxinfo" id="T3:U33"><span class="var type1" id="S547T3U2927">HipYawPitch_k</span> = <span class="var type1" id="S536T3U2929">HipYawPitch</span>(<span class="var type1" id="S546T3U2930">k</span>)</span>;   </span></span>
<span class="srcline"><span class="lineno"><a href="1,560" id="srcline560">560</a></span><span class="line">    <span class="mxinfo" id="T7:U37"><span class="var type1" id="S548T7U2933">Q_AxisL</span> = <span class="mxinfo" id="T7:U39"><span class="mxinfo" id="T7:U40"><span class="var type1" id="S540T7U2935">AxisL</span></span>*<span class="mxinfo" id="T3:U42">sin( <span class="mxinfo" id="T3:U43"><span class="var type1" id="S547T3U2939">HipYawPitch_k</span>/<span class="mxinfo" id="T3:U45">2</span></span> )</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,561" id="srcline561">561</a></span><span class="line">    <span class="mxinfo" id="T37:U46"><span class="var type1" id="S550T37U2943">Q_HipYawPitch_k</span> = <span class="mxinfo" id="T37:U48">[ <span class="mxinfo" id="T3:U49">cos( <span class="mxinfo" id="T3:U50"><span class="var type1" id="S547T3U2949">HipYawPitch_k</span>/<span class="mxinfo" id="T3:U52">2</span></span> )</span> <span class="var type1" id="S548T7U2951">Q_AxisL</span> ]</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,562" id="srcline562">562</a></span><span class="line">    <span class="mxinfo" id="T18:U54"><span class="mxinfo" id="T18:U55"><span class="var type1" id="S544T18U2955">C_HipYawPitch</span>(<span class="mxinfo" id="T3:U57"><span class="var type1" id="S546T3U2956">k</span></span>,:,:)</span> = <span class="mxinfo" id="T13:U59"><span class="fcn" id="F207N12:B2960">FQtoCnb</span>( <span class="var type1" id="S550T37U2961">Q_HipYawPitch_k</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,563" id="srcline563">563</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,564" id="srcline564">564</a></span><span class="line"><span class="mxinfo" id="T18:U61"><span class="var type1" id="S553T18U2964">C_LUpLeg_SecondHip</span> = <span class="mxinfo" id="T18:U63"><span class="fcn" id="F75N5:B2966">CalculateC_Multi</span>( <span class="var type1" id="S538T18U2967">C_LUpLeg_Hip</span>,<span class="var type1" id="S544T18U2968">C_HipYawPitch</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,565" id="srcline565">565</a></span><span class="line"><span class="mxinfo" id="T18:U66"><span class="var type1" id="S553T18U2971">C_LUpLeg_SecondHip</span> = <span class="var type1" id="S538T18U2972">C_LUpLeg_Hip</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,566" id="srcline566">566</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,567" id="srcline567">567</a></span><span class="line"><span class="mxinfo" id="T3:U69"><span class="var type1" id="S533T3U2975">LHipPitch</span> = <span class="mxinfo" id="T3:U71">zeros(1,<span class="var type1" id="S542T3U2979">Nframes</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,568" id="srcline568">568</a></span><span class="line"><span class="mxinfo" id="T3:U73"><span class="var type1" id="S532T3U2982">LHipRoll</span> = <span class="mxinfo" id="T3:U75">zeros(1,<span class="var type1" id="S542T3U2986">Nframes</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,569" id="srcline569">569</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S546T3U2989">k</span>=<span class="mxinfo" id="T3:U78">1:<span class="var type1" id="S542T3U2992">Nframes</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,570" id="srcline570">570</a></span><span class="line">    <span class="mxinfo" id="T13:U80"><span class="var type1" id="S555T13U2995">C_LUpLeg_SecondHip_k</span> = <span class="mxinfo" id="T13:U82">permute( <span class="mxinfo" id="T18:U83"><span class="var type1" id="S553T18U2999">C_LUpLeg_SecondHip</span>(<span class="mxinfo" id="T3:U85"><span class="var type1" id="S546T3U3000">k</span></span>,:,:)</span>,[2,3,1] )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,571" id="srcline571">571</a></span><span class="line">    <span class="mxinfo" id="T3:U87">[<span class="var type1" id="S557T3U3011">x</span>,<span class="var type1" id="S558T3U3012">y</span>,<span class="var type1" id="S559T3U3013">z</span>] = deal( <span class="mxinfo" id="T3:U91"><span class="var type1" id="S555T13U3017">C_LUpLeg_SecondHip_k</span>(<span class="mxinfo" id="T3:U93">1</span>,<span class="mxinfo" id="T3:U94">2</span>)</span>,<span class="mxinfo" id="T3:U95"><span class="var type1" id="S555T13U3021">C_LUpLeg_SecondHip_k</span>(<span class="mxinfo" id="T3:U97">2</span>,<span class="mxinfo" id="T3:U98">2</span>)</span>,<span class="mxinfo" id="T3:U99"><span class="var type1" id="S555T13U3025">C_LUpLeg_SecondHip_k</span>(<span class="mxinfo" id="T3:U101">3</span>,<span class="mxinfo" id="T3:U102">2</span>)</span> )</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,572" id="srcline572">572</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,573" id="srcline573">573</a></span><span class="line">    <span class="mxinfo" id="T3:U103"><span class="var type1" id="S533T3U3031">LHipPitch</span>(<span class="var type1" id="S546T3U3032">k</span>) = <span class="mxinfo" id="T3:U106">asin( <span class="var type1" id="S559T3U3035">z</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,574" id="srcline574">574</a></span><span class="line">    <span class="mxinfo" id="T3:U108"><span class="var type1" id="S532T3U3039">LHipRoll</span>(<span class="var type1" id="S546T3U3040">k</span>) = <span class="mxinfo" id="T3:U111">atan( <span class="mxinfo" id="T3:U112"><span class="mxinfo" id="T3:U113">-<span class="var type1" id="S557T3U3045">x</span></span>/<span class="var type1" id="S558T3U3046">y</span></span> )</span></span>;    </span></span>
<span class="srcline"><span class="lineno"><a href="1,575" id="srcline575">575</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,576" id="srcline576">576</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,577" id="srcline577">577</a></span><span class="line"><span class="mxinfo" id="T7:U116"><span class="var type1" id="S563T7U3049">E_Hip_LUpLeg_ZXY</span> = <span class="mxinfo" id="T7:U118">[ <span class="var type1" id="S532T3U3053">LHipRoll</span>' <span class="var type1" id="S533T3U3055">LHipPitch</span>' <span class="mxinfo" id="T3:U121">zeros(<span class="var type1" id="S542T3U3058">Nframes</span>,1)</span> ]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,578" id="srcline578">578</a></span><span class="line"><span class="mxinfo" id="T18:U123"><span class="var type1" id="S564T18U3062">C_Hip_LUpLeg_ZXY</span> = <span class="mxinfo" id="T18:U125"><span class="fcn" id="F45N11:B3064">EulerToC_c</span>( <span class="var type1" id="S563T7U3065">E_Hip_LUpLeg_ZXY</span>,<span class="mxinfo" id="T3:U127">312</span>,<span class="mxinfo" id="T7:U128">[1,1,1]</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,579" id="srcline579">579</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,580" id="srcline580">580</a></span><span class="line"><span class="mxinfo" id="T27:U129"><span class="var type1" id="S566T27U3074">pos</span> = <span class="mxinfo" id="T27:U131">zeros( <span class="mxinfo" id="T3:U132">3</span>,<span class="var type1" id="S542T3U3078">Nframes</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,581" id="srcline581">581</a></span><span class="line"><span class="mxinfo" id="T27:U134"><span class="var type1" id="S567T27U3081">posNew</span> = <span class="mxinfo" id="T27:U136">zeros( <span class="mxinfo" id="T3:U137">3</span>,<span class="var type1" id="S542T3U3085">Nframes</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,582" id="srcline582">582</a></span><span class="line"><span class="mxinfo" id="T27:U139"><span class="var type1" id="S568T27U3088">pos_err</span> = <span class="mxinfo" id="T27:U141">zeros( <span class="mxinfo" id="T3:U142">3</span>,<span class="var type1" id="S542T3U3092">Nframes</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,583" id="srcline583">583</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S546T3U3095">k</span>=<span class="mxinfo" id="T3:U145">1:<span class="var type1" id="S542T3U3098">Nframes</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,584" id="srcline584">584</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,585" id="srcline585">585</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,586" id="srcline586">586</a></span><span class="line">    <span class="mxinfo" id="T13:U147"><span class="var type1" id="S555T13U3101">C_LUpLeg_SecondHip_k</span> = <span class="mxinfo" id="T13:U149">permute( <span class="mxinfo" id="T18:U150"><span class="var type1" id="S553T18U3105">C_LUpLeg_SecondHip</span>(<span class="mxinfo" id="T3:U152"><span class="var type1" id="S546T3U3106">k</span></span>,:,:)</span>,[2 3 1] )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,587" id="srcline587">587</a></span><span class="line">    <span class="mxinfo" id="T13:U154"><span class="var type1" id="S569T13U3116">C_Hip_LUpLeg_ZXY_k</span> = <span class="mxinfo" id="T13:U156">permute( <span class="mxinfo" id="T18:U157"><span class="var type1" id="S564T18U3120">C_Hip_LUpLeg_ZXY</span>(<span class="mxinfo" id="T3:U159"><span class="var type1" id="S546T3U3121">k</span></span>,:,:)</span>,[2 3 1] )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,588" id="srcline588">588</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,589" id="srcline589">589</a></span><span class="line">    <span class="mxinfo" id="T27:U161"><span class="mxinfo" id="T27:U162"><span class="var type1" id="S566T27U3132">pos</span>(:,<span class="mxinfo" id="T3:U164"><span class="var type1" id="S546T3U3134">k</span></span>)</span> = <span class="mxinfo" id="T27:U166"><span class="var type1" id="S555T13U3136">C_LUpLeg_SecondHip_k</span>*<span class="mxinfo" id="T27:U168">[0;1;0]</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,590" id="srcline590">590</a></span><span class="line">    <span class="mxinfo" id="T27:U169"><span class="mxinfo" id="T27:U170"><span class="var type1" id="S567T27U3147">posNew</span>(:,<span class="mxinfo" id="T3:U172"><span class="var type1" id="S546T3U3149">k</span></span>)</span> = <span class="mxinfo" id="T27:U174"><span class="mxinfo" id="T13:U175"><span class="var type1" id="S569T13U3152">C_Hip_LUpLeg_ZXY_k</span>'</span>*<span class="mxinfo" id="T27:U177">[0;1;0]</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,591" id="srcline591">591</a></span><span class="line">    <span class="mxinfo" id="T27:U178"><span class="mxinfo" id="T27:U179"><span class="var type1" id="S568T27U3163">pos_err</span>(:,<span class="mxinfo" id="T3:U181"><span class="var type1" id="S546T3U3165">k</span></span>)</span> = <span class="mxinfo" id="T27:U183"><span class="mxinfo" id="T27:U184"><span class="var type1" id="S566T27U3168">pos</span>(:,<span class="mxinfo" id="T3:U186"><span class="var type1" id="S546T3U3170">k</span></span>)</span>-<span class="mxinfo" id="T27:U188"><span class="var type1" id="S567T27U3172">posNew</span>(:,<span class="mxinfo" id="T3:U190"><span class="var type1" id="S546T3U3174">k</span></span>)</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,592" id="srcline592">592</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,593" id="srcline593">593</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,594" id="srcline594">594</a></span><span class="line"><span class="mxinfo" id="T3:U192"><span class="var type1" id="S570T3U3177">pos_err_sum</span> = <span class="mxinfo" id="T3:U194">sum( <span class="mxinfo" id="T3:U195">sum( <span class="mxinfo" id="T27:U196">abs( <span class="var type1" id="S568T27U3184">pos_err</span> )</span> )</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,595" id="srcline595">595</a></span><span class="line"><span class="comment">% if pos_err_sum&gt;1e-1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,596" id="srcline596">596</a></span><span class="line"><span class="comment">%     for k=1:Nframes</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,597" id="srcline597">597</a></span><span class="line"><span class="comment">%         LHipPitch(k) = pi-LHipPitch(k) ;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,598" id="srcline598">598</a></span><span class="line"><span class="comment">%     end    </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,599" id="srcline599">599</a></span><span class="line"><span class="comment">%     E_Hip_LUpLeg_ZXY = [ LHipRoll' LHipPitch' zeros(Nframes,1) ];</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,600" id="srcline600">600</a></span><span class="line"><span class="comment">%     C_Hip_LUpLeg_ZXY = EulerToC_c( E_Hip_LUpLeg_ZXY,312,[1,1,1] );</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,601" id="srcline601">601</a></span><span class="line"><span class="comment">% end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,602" id="srcline602">602</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,603" id="srcline603">603</a></span><span class="line"><span class="comment">%%% get new BVH</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,604" id="srcline604">604</a></span><span class="line"><span class="mxinfo" id="T7:U198"><span class="var type1" id="S534T7U3187">LeftUpLeg_new</span> = <span class="mxinfo" id="T7:U200"><span class="fcn" id="F96N4:B3189">CToEuler_c</span>( <span class="var type1" id="S564T18U3190">C_Hip_LUpLeg_ZXY</span>,<span class="var type1" id="S537T3U3191">rotateOrder_BVH</span>,<span class="mxinfo" id="T7:U203">[1,1,1]</span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,605" id="srcline605">605</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,606" id="srcline606">606</a></span><span class="line"><span class="comment">%% RLeg</span></span></span>
</pre>
