<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"><span class="comment">% otherMakers(k).trackedMakerPosition  = NaN(3,1);   </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"><span class="comment">% otherMakers(k).ContinuesFlag = zeros(1,M) ; % 不连续</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line"><span class="comment">% otherMakers(k).ContinuesLastPosition = NaN(3,M)  ;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line"><span class="comment">% otherMakers(k).ContinuesLastTime = NaN[1*M] ; </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line"><span class="comment">% otherMakers(k).ContinuesLastK = NaN[1*M];</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line"><span class="keyword">function</span> [ <span class="var type1" id="S2T92U3">MatchedVNSP</span>,<span class="var type1" id="S3T93U4">INSA_TestOut</span>,<span class="var type1" id="S4T94U5">otherMakersContinuesTestOut</span>,<span class="var type1" id="S5T95U6">vns_kTestOut</span> ]  = INS_VNS_Match<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line">    ( <span class="var type1" id="S6T4U9">INSA_All_k</span>,<span class="var type1" id="S7T1U10">inertialFre</span>,<span class="var type1" id="S8T70U11">otherMakersPosition_k</span>,<span class="var type1" id="S9T5U12">otherMakersN_k</span>,<span class="var type1" id="S10T1U13">visionFre</span>,<span class="var type1" id="S11T1U14">MinMatchDegreeIn</span> )</span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"><span class="keyword">global</span>  <span class="var type1" id="S12T1U16">MinMatchDegree</span>     </span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"><span class="comment">%% 参数设置</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"><span class="var type0" id="S12T0U19">MinMatchDegree</span> = <span class="var type1" id="S11T1U20">MinMatchDegreeIn</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"><span class="var type1" id="S13T2U23">BufferTime</span> = 10; <span class="comment">% sec  数据缓存时间长度</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"><span class="var type1" id="S14T2U27">IBN</span>  = fix(<span class="var type1" id="S13T2U31">BufferTime</span>*120);</span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line"><span class="var type1" id="S16T2U35">VBN</span> = fix(<span class="var type1" id="S13T2U39">BufferTime</span>*120);</span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line"><span class="var type1" id="S17T2U43">Max_otherMakersN</span> = 20;  <span class="comment">% 最多存 20  个马克点的位置</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line"><span class="var type1" id="S18T2U47">IsOnlyLost</span> = 1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line"><span class="var type1" id="S19T2U51">INS_Joint_N</span>=6;</span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line"><span class="comment">%% 输入预处理</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line"><span class="var type1" id="S20T3U55">IsINSReceived</span> = ~ isempty( <span class="var type1" id="S6T4U59">INSA_All_k</span> ) ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"><span class="var type1" id="S22T3U62">IsVNSReceived</span> = ~ isempty( <span class="var type1" id="S9T5U66">otherMakersN_k</span> );</span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line"><span class="comment">%% OUT</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line"><span class="var type0" id="S3T0U69">INSA_TestOut</span> = [];</span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line"><span class="var type0" id="S5T0U74">vns_kTestOut</span>=[];</span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line"><span class="var type0" id="S4T0U79">otherMakersContinuesTestOut</span>=[];</span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"><span class="comment">%% 时间同步参数</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"><span class="keyword">persistent</span> <span class="var type1" id="S23T2U83">ins_k_g</span>  <span class="var type1" id="S24T2U84">vns_k_g</span>   <span class="comment">% 全局的序号，从第一帧起一直往前增加</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S20T3U87">IsINSReceived</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T3:U28">isempty( <span class="var type0" id="S23T0U92">ins_k_g</span> )</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line">        <span class="var type1" id="S23T2U95">ins_k_g</span> = 0;  <span class="comment">% 第一帧到来前</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line">    <span class="var type1" id="S23T2U99">ins_k_g</span> = <span class="var type1" id="S23T2U101">ins_k_g</span>+1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S22T3U105">IsVNSReceived</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T3:U33">isempty( <span class="var type0" id="S24T0U110">vns_k_g</span> )</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line">        <span class="var type1" id="S24T2U113">vns_k_g</span> = 0;  <span class="comment">% 第一帧到来前</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line">    <span class="var type1" id="S24T2U117">vns_k_g</span> = <span class="var type1" id="S24T2U119">vns_k_g</span>+1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line"><span class="keyword">persistent</span> <span class="var type1" id="S25T2U122">ins_k</span>  <span class="var type1" id="S26T2U123">vns_k</span>  <span class="comment">%  在缓存区内部的序号</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S20T3U126">IsINSReceived</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T3:U40">isempty( <span class="var type0" id="S25T0U131">ins_k</span> )</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line">        <span class="var type1" id="S25T2U134">ins_k</span> = 0;  <span class="comment">% 第一帧到来前</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S22T3U138">IsVNSReceived</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T3:U43">isempty( <span class="var type0" id="S26T0U143">vns_k</span> )</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line">        <span class="var type1" id="S26T2U146">vns_k</span> = 0;  <span class="comment">% 第一帧到来前</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line"><span class="comment">%% 存储惯性加速度</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line"><span class="keyword">persistent</span> <span class="var type1" id="S27T6U149">INSA_All</span>   <span class="var type1" id="S28T61U150">INSWaveResult</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line"><span class="comment">% INSA_All [INS_Joint_N * 3 * IBN]  惯性加速度缓存</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S20T3U153">IsINSReceived</span>    </span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T3:U48">isempty(<span class="var type0" id="S27T0U158">INSA_All</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line"><span class="comment">%         INS_Joint_N = size(INSA_All_k,1)/3;  % 惯性节点个数，要求始终保持 个数 和 顺序 不变</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line"><span class="comment">%         if mod(INS_Joint_N,1)~=0</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line"><span class="comment">%            disp('error INS_Joint_N'); </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line"><span class="comment">%         end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line">        <span class="var type1" id="S27T6U161">INSA_All</span> = NaN( <span class="var type1" id="S19T2U165">INS_Joint_N</span>*3,<span class="var type1" id="S14T2U167">IBN</span> );        </span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line">    [ <span class="var type1" id="S27T6U171">INSA_All</span>,<span class="var type1" id="S25T2U172">ins_k</span>,<span class="var type1" id="S30T2U173">removeN</span> ] = <span class="fcn" id="F5N2:B175">AddListData</span>( <span class="var type1" id="S27T6U176">INSA_All</span>,<span class="var type1" id="S25T2U177">ins_k</span>,<span class="var type1" id="S6T4U179">INSA_All_k</span>(1:<span class="var type1" id="S19T2U183">INS_Joint_N</span>*3,:) );</span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line">    <span class="comment">%% 惯性加速度 波形分析</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line">    [<span class="var type1" id="S32T6U189">INSA_WaveFlag_All</span>,<span class="var type1" id="S3T35U190">INSA_TestOut</span>] = <span class="fcn" id="F71N14:B192">INSA_Wave_Analyze</span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line">        ( <span class="var type1" id="S27T6U193">INSA_All</span>, <span class="var type1" id="S19T2U194">INS_Joint_N</span>,<span class="var type1" id="S25T2U195">ins_k</span>,<span class="var type1" id="S14T2U196">IBN</span>,<span class="var type1" id="S7T1U197">inertialFre</span>,<span class="var type1" id="S30T2U198">removeN</span> ) ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line">    <span class="var type1" id="S34T42U201">INSA_ValidN</span> = ones( size(<span class="var type1" id="S32T6U207">INSA_WaveFlag_All</span>,1),1 )*<span class="var type1" id="S25T2U210">ins_k</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line">    <span class="var type0" id="S28T0U213">INSWaveResult</span> = <span class="fcn" id="F269N13:B215">GetWaveResult</span>( <span class="var type1" id="S32T6U216">INSA_WaveFlag_All</span>,<span class="var type1" id="S34T42U217">INSA_ValidN</span>,<span class="var type1" id="S23T2U218">ins_k_g</span>,<span class="var type1" id="S7T1U219">inertialFre</span> );</span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line">    <span class="keyword">if</span> coder.target(<span class="string">'MATLAB'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line">        <span class="var type0" id="S3T0U230">INSA_TestOut</span>.validN = <span class="var type0" id="S25T0U232">ins_k</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line">        <span class="var type0" id="S3T0U236">INSA_TestOut</span>.timeN = <span class="var type0" id="S23T0U238">ins_k_g</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line">    <span class="var type1" id="S39T2U241">IsLostMark</span>=0;  <span class="comment">% 惯性受到数据，视觉没有的情况下，不匹配</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line"><span class="comment">%% 存储视觉马克点</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line"><span class="keyword">persistent</span> <span class="var type1" id="S40T69U244">otherMakers</span>  <span class="var type1" id="S41T62U245">otherMakers_k_new</span> <span class="var type0" id="S42T0U246">VNSWaveResult</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S22T3U249">IsVNSReceived</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T3:U78">isempty(<span class="var type0" id="S40T0U254">otherMakers</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line">        <span class="var type1" id="S40T69U257">otherMakers</span> = <span class="fcn" id="F270N29:B259">otherMakersInitial</span>( <span class="var type1" id="S16T2U260">VBN</span>,<span class="var type1" id="S10T1U261">visionFre</span>,<span class="var type1" id="S17T2U262">Max_otherMakersN</span> );  <span class="comment">% 频率只读这一次</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line">        <span class="var type1" id="S41T62U265">otherMakers_k_new</span> = <span class="var type1" id="S40T69U267">otherMakers</span>(1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line">    <span class="var type1" id="S41T62U272">otherMakers_k_new</span>.otherMakersN = double(<span class="var type1" id="S9T5U276">otherMakersN_k</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line">    <span class="var type1" id="S41T62U280">otherMakers_k_new</span>.Position = double(<span class="var type1" id="S8T70U284">otherMakersPosition_k</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line">    <span class="var type1" id="S41T62U288">otherMakers_k_new</span>.time = double(<span class="var type1" id="S24T2U293">vns_k_g</span>/<span class="var type1" id="S10T1U294">visionFre</span>) ;       <span class="comment">% 当算法对时间同步要求低时，近似通过频率计算时间</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line">    [ <span class="var type1" id="S40T69U298">otherMakers</span>,<span class="var type1" id="S26T2U299">vns_k</span> ] = <span class="fcn" id="F290N3:B301">AddListotherMakers</span>( <span class="var type1" id="S40T69U302">otherMakers</span>,<span class="var type1" id="S26T2U303">vns_k</span>,<span class="var type1" id="S41T62U304">otherMakers_k_new</span> );</span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line">    <span class="comment">%% 连续性分析</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S26T2U308">vns_k</span>&gt;1</span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line">        [ <span class="var type1" id="S40T69U313">otherMakers</span>,<span class="var type1" id="S39T2U314">IsLostMark</span> ] = <span class="fcn" id="F291N12:B316">ContinuesAnalyze</span>( <span class="var type1" id="S40T69U317">otherMakers</span>,<span class="var type1" id="S26T2U318">vns_k</span>,<span class="var type1" id="S19T2U319">INS_Joint_N</span>,<span class="var type1" id="S10T1U320">visionFre</span>,<span class="var type1" id="S16T2U321">VBN</span> );</span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line">    <span class="comment">%% 视觉马克点波形分析</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S26T2U326">vns_k</span>&gt;1 &amp;&amp; <span class="var type1" id="S39T2U328">IsLostMark</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line">        <span class="message fatal" id="M1F1C">[ <span class="var type0" id="S40T0U332">otherMakers</span>,<span class="var type0" id="S47T0U333">VNSA_WaveFlag_All</span>,<span class="var type0" id="S48T0U334">VNSP_ValidN_All</span>,<span class="var type0" id="S4T0U335">otherMakersContinuesTestOut</span> ] = <span class="fcn" id="F405N17:B337">VNSP_AWave_Analyze</span>( <span class="var type1" id="S40T69U338">otherMakers</span>,<span class="var type1" id="S26T2U339">vns_k</span>,<span class="var type1" id="S16T2U340">VBN</span>,<span class="var type1" id="S18T2U341">IsOnlyLost</span> )</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line">        <span class="var type0" id="S42T0U344">VNSWaveResult</span> = GetWaveResult( <span class="var type0" id="S47T0U347">VNSA_WaveFlag_All</span>,<span class="var type0" id="S48T0U348">VNSP_ValidN_All</span>,<span class="var type0" id="S24T0U349">vns_k_g</span>,<span class="var type0" id="S10T0U350">visionFre</span> );</span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line">    <span class="var type0" id="S5T0U353">vns_kTestOut</span> = <span class="var type0" id="S24T0U354">vns_k_g</span>;    </span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line"><span class="keyword">if</span> isempty(<span class="var type0" id="S26T0U362">vns_k</span>) || isempty(<span class="var type0" id="S25T0U365">ins_k</span>) || <span class="var type0" id="S26T0U367">vns_k</span>&lt;2 || <span class="var type0" id="S25T0U370">ins_k</span>&lt;2</span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line">    <span class="var type0" id="S2T0U374">MatchedVNSP</span> = NaN(<span class="var type0" id="S19T0U378">INS_Joint_N</span>*3,1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line">    <span class="keyword">return</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line"><span class="comment">%% 所有惯性点 与 所有视觉点 进行匹配</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line"><span class="keyword">if</span>  <span class="var type0" id="S39T0U384">IsLostMark</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line">    <span class="var type0" id="S50T0U387">MarkerMatchingINSk</span> = WaveMatch( <span class="var type0" id="S28T0U390">INSWaveResult</span>,<span class="var type0" id="S42T0U391">VNSWaveResult</span>,<span class="var type0" id="S18T0U392">IsOnlyLost</span>,<span class="var type0" id="S40T0U395">otherMakers</span>(<span class="var type0" id="S26T0U396">vns_k</span>).InitialJointK );</span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line">    <span class="var type0" id="S50T0U401">MarkerMatchingINSk</span>=[];</span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line"><span class="comment">%%  用 MarkerMatchingINSk 更新  otherMakers(vns_k).InitialJointK</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line"><span class="keyword">if</span>  <span class="var type0" id="S39T0U406">IsLostMark</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line">    <span class="var type0" id="S9T0U409">otherMakersN_k</span> = <span class="var type0" id="S40T0U412">otherMakers</span>(<span class="var type0" id="S26T0U413">vns_k</span>).otherMakersN;</span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line">    <span class="keyword">for</span> <span class="var type0" id="S52T0U417">i</span>=1:<span class="var type0" id="S9T0U420">otherMakersN_k</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line">        <span class="var type0" id="S53T0U423">MarkerMatchingINSk_i</span>  = <span class="var type0" id="S50T0U425">MarkerMatchingINSk</span>(<span class="var type0" id="S52T0U426">i</span>,1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line">        <span class="keyword">if</span> ~isnan(<span class="var type0" id="S53T0U434">MarkerMatchingINSk_i</span>)   &amp;&amp;  <span class="var type0" id="S50T0U437">MarkerMatchingINSk</span>(<span class="var type0" id="S52T0U438">i</span>,2) &gt; <span class="var type0" id="S12T0U440">MinMatchDegree</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,160" id="srcline160">160</a></span><span class="line">            <span class="comment">% 该点有匹配结果</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,161" id="srcline161">161</a></span><span class="line">            <span class="var type0" id="S55T0U443">InitialJointK_old</span> = <span class="var type0" id="S40T0U447">otherMakers</span>(<span class="var type0" id="S26T0U448">vns_k</span>).InitialJointK(<span class="var type0" id="S52T0U450">i</span>) ;  <span class="comment">% 通过连续性判断的结果</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,162" id="srcline162">162</a></span><span class="line">            <span class="keyword">if</span> isnan( <span class="var type0" id="S55T0U455">InitialJointK_old</span> )</span></span>
<span class="srcline"><span class="lineno"><a href="1,163" id="srcline163">163</a></span><span class="line">                <span class="comment">% 之前丢失</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,164" id="srcline164">164</a></span><span class="line">                <span class="var type0" id="S40T0U461">otherMakers</span>(<span class="var type0" id="S26T0U462">vns_k</span>).InitialJointK(<span class="var type0" id="S52T0U464">i</span>) = <span class="var type0" id="S53T0U465">MarkerMatchingINSk_i</span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,165" id="srcline165">165</a></span><span class="line">                fprintf(<span class="string">'跟踪成功了丢失的点, k=%d t=%0.3f sec，匹配度=%0.4f \n'</span>,<span class="var type0" id="S24T0U470">vns_k_g</span>,<span class="var type0" id="S24T0U472">vns_k_g</span>/<span class="var type0" id="S10T0U473">visionFre</span>,<span class="var type0" id="S50T0U475">MarkerMatchingINSk</span>(<span class="var type0" id="S52T0U476">i</span>,2) );</span></span>
<span class="srcline"><span class="lineno"><a href="1,166" id="srcline166">166</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,167" id="srcline167">167</a></span><span class="line">                <span class="comment">% 通过连续性已经得到结果</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,168" id="srcline168">168</a></span><span class="line">                <span class="keyword">if</span> <span class="var type0" id="S55T0U482">InitialJointK_old</span>~=<span class="var type0" id="S53T0U483">MarkerMatchingINSk_i</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,169" id="srcline169">169</a></span><span class="line">                   errordlg(<span class="string">'连续性和加速度波形的判断结果不同！'</span>); </span></span>
<span class="srcline"><span class="lineno"><a href="1,170" id="srcline170">170</a></span><span class="line">                <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,171" id="srcline171">171</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,172" id="srcline172">172</a></span><span class="line">        <span class="keyword">end</span>        </span></span>
<span class="srcline"><span class="lineno"><a href="1,173" id="srcline173">173</a></span><span class="line">    <span class="keyword">end</span>     </span></span>
<span class="srcline"><span class="lineno"><a href="1,174" id="srcline174">174</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,175" id="srcline175">175</a></span><span class="line">    <span class="var type0" id="S58T0U490">InitialJointK_k</span> = <span class="var type0" id="S40T0U494">otherMakers</span>(<span class="var type0" id="S26T0U495">vns_k</span>).InitialJointK(1:<span class="var type0" id="S19T0U499">INS_Joint_N</span>) ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,176" id="srcline176">176</a></span><span class="line">    <span class="var type0" id="S59T0U502">IsMatchOK</span> =  ~sum(isnan(<span class="var type0" id="S58T0U508">InitialJointK_k</span>)) ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,177" id="srcline177">177</a></span><span class="line">    <span class="keyword">if</span> <span class="var type0" id="S59T0U511">IsMatchOK</span> </span></span>
<span class="srcline"><span class="lineno"><a href="1,178" id="srcline178">178</a></span><span class="line">        disp(<span class="string">'全部匹配OK'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,179" id="srcline179">179</a></span><span class="line">    <span class="keyword">end</span>  </span></span>
<span class="srcline"><span class="lineno"><a href="1,180" id="srcline180">180</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,181" id="srcline181">181</a></span><span class="line">  </span></span>
<span class="srcline"><span class="lineno"><a href="1,182" id="srcline182">182</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,183" id="srcline183">183</a></span><span class="line"><span class="comment">%% MatchedVNSP ： 按惯性顺序存储的马克点位置</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,184" id="srcline184">184</a></span><span class="line"><span class="comment">%  [3*20] 与惯性节点匹配的马克点位置，顺序与 INSA_All_k 一致</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,185" id="srcline185">185</a></span><span class="line"><span class="var type0" id="S2T0U518">MatchedVNSP</span> = NaN(<span class="var type0" id="S19T0U522">INS_Joint_N</span>*3,1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,186" id="srcline186">186</a></span><span class="line"><span class="keyword">if</span> ~isempty(<span class="var type0" id="S26T0U533">vns_k</span>) &amp;&amp; ~isempty(<span class="var type0" id="S25T0U537">ins_k</span>) &amp;&amp; <span class="var type0" id="S26T0U539">vns_k</span>&gt;1 &amp;&amp; <span class="var type0" id="S25T0U542">ins_k</span>&gt;1</span></span>
<span class="srcline"><span class="lineno"><a href="1,187" id="srcline187">187</a></span><span class="line">    <span class="var type0" id="S9T0U546">otherMakersN_k</span> = <span class="var type0" id="S40T0U549">otherMakers</span>(<span class="var type0" id="S26T0U550">vns_k</span>).otherMakersN;</span></span>
<span class="srcline"><span class="lineno"><a href="1,188" id="srcline188">188</a></span><span class="line">    <span class="var type0" id="S62T0U554">Position_k</span> = <span class="var type0" id="S40T0U557">otherMakers</span>(<span class="var type0" id="S26T0U558">vns_k</span>).Position;</span></span>
<span class="srcline"><span class="lineno"><a href="1,189" id="srcline189">189</a></span><span class="line">    <span class="keyword">for</span> <span class="var type0" id="S52T0U562">i</span>=1:<span class="var type0" id="S9T0U565">otherMakersN_k</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,190" id="srcline190">190</a></span><span class="line">        <span class="var type0" id="S63T0U568">InitialJointK_i</span> = <span class="var type0" id="S40T0U572">otherMakers</span>(<span class="var type0" id="S26T0U573">vns_k</span>).InitialJointK(<span class="var type0" id="S52T0U575">i</span>); <span class="comment">% 第 i 个马克点对应的惯性节点序号</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,191" id="srcline191">191</a></span><span class="line">        <span class="keyword">if</span> <span class="var type0" id="S63T0U579">InitialJointK_i</span> &gt; 0</span></span>
<span class="srcline"><span class="lineno"><a href="1,192" id="srcline192">192</a></span><span class="line">            <span class="var type0" id="S2T0U584">MatchedVNSP</span>( <span class="var type0" id="S63T0U588">InitialJointK_i</span>*3-2:<span class="var type0" id="S63T0U592">InitialJointK_i</span>*3 ,: ) = <span class="var type0" id="S62T0U596">Position_k</span>(:,<span class="var type0" id="S52T0U598">i</span>) ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,193" id="srcline193">193</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,194" id="srcline194">194</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,195" id="srcline195">195</a></span><span class="line"><span class="keyword"><span class="keyword">end</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,196" id="srcline196">196</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,197" id="srcline197">197</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,198" id="srcline198">198</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,199" id="srcline199">199</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,200" id="srcline200">200</a></span><span class="line"><span class="comment">%%  所有惯性点 与 所有视觉点 进行匹配</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,201" id="srcline201">201</a></span><span class="line"><span class="comment">% WaveResult </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,202" id="srcline202">202</a></span><span class="line"><span class="comment">% M = 3*PointN  点个数的3倍  </span></span></span>
</pre>
