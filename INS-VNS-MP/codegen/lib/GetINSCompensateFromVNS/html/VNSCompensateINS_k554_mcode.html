<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,168" id="srcline168">168</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,169" id="srcline169">169</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,170" id="srcline170">170</a></span><span class="line"><span class="comment">%% 单帧 位移补偿 k时刻</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,171" id="srcline171">171</a></span><span class="line"><span class="comment">%%% Input</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,172" id="srcline172">172</a></span><span class="line"><span class="comment">% trackedMakerPosition_InertialTime ： 马克点光学位置，按惯性时序存储</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,173" id="srcline173">173</a></span><span class="line"><span class="comment">% HipDisplacement ： Hip在北东地下的位置 （由 BVH 得到）</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,174" id="srcline174">174</a></span><span class="line"><span class="comment">% InertialPosition_k： [3,2] k-1和k时刻   惯性系与马克点安装位置对应关节的位置（安装在头上时，InertialPosition 为惯性头的位置）</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,175" id="srcline175">175</a></span><span class="line"><span class="comment">%%% Output</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,176" id="srcline176">176</a></span><span class="line"><span class="comment">% InertialPositionNew ： 补偿后惯性的位置</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,177" id="srcline177">177</a></span><span class="line"><span class="comment">% HipDisplacementNew： 补偿后Hip的位置</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,178" id="srcline178">178</a></span><span class="line"><span class="keyword">function</span> [ <span class="var type1" id="S41T6U442">SingleFrameCompensate_k</span>,<span class="var type1" id="S42T6U443">AccumulateCompensate_k</span>,<span class="var type1" id="S43T6U444">InertialPositionNew_k</span> ] = VNSCompensateINS_k<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,179" id="srcline179">179</a></span><span class="line">( <span class="var type1" id="S44T2U447">compensateRate</span>,<span class="var type1" id="S45T6U448">trackedMakerPosition_InertialTime_k</span>,<span class="var type1" id="S46T67U449">InertialPosition_k</span>,<span class="var type1" id="S47T6U450">InertialPositionNew_k_last</span> )</span></span>
<span class="srcline"><span class="lineno"><a href="1,180" id="srcline180">180</a></span><span class="line">coder.inline(<span class="string">'never'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,181" id="srcline181">181</a></span><span class="line"><span class="comment">% coder.extrinsic('fprintf');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,182" id="srcline182">182</a></span><span class="line"><span class="comment">% coder.extrinsic('DrawCompensate');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,183" id="srcline183">183</a></span><span class="line"><span class="comment">% global CalStartIN  CalEndIN     </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,184" id="srcline184">184</a></span><span class="line"><span class="comment">% persistent InertialPositionNew_k  % 在k-1时刻补偿后位置的基础上，进行一步纯惯性递推得到的位置</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,185" id="srcline185">185</a></span><span class="line"><span class="comment">% 先用纯惯性递推：在前一时刻补偿后基础上，惯性递推一步得到的位移</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,186" id="srcline186">186</a></span><span class="line"><span class="mxinfo" id="T6:U8"><span class="var type1" id="S43T6U459">InertialPositionNew_k</span> = <span class="mxinfo" id="T6:U10"><span class="var type1" id="S47T6U461">InertialPositionNew_k_last</span>+( <span class="mxinfo" id="T6:U12"><span class="mxinfo" id="T6:U13"><span class="var type1" id="S46T67U465">InertialPosition_k</span>(:,<span class="mxinfo" id="T2:U15">2</span>)</span>-<span class="mxinfo" id="T6:U16"><span class="var type1" id="S46T67U469">InertialPosition_k</span>(:,<span class="mxinfo" id="T2:U18">1</span>)</span></span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,187" id="srcline187">187</a></span><span class="line"><span class="comment">% 先求纯惯性误差</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,188" id="srcline188">188</a></span><span class="line"><span class="mxinfo" id="T6:U19"><span class="var type1" id="S49T6U474">InertialErr_k</span> = <span class="mxinfo" id="T6:U21"><span class="var type1" id="S45T6U476">trackedMakerPosition_InertialTime_k</span> - <span class="var type1" id="S43T6U477">InertialPositionNew_k</span></span></span> ;  <span class="comment">% 当前相对光学的误差</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,189" id="srcline189">189</a></span><span class="line"><span class="mxinfo" id="T2:U24"><span class="mxinfo" id="T2:U25"><span class="var type1" id="S49T6U481">InertialErr_k</span>(<span class="mxinfo" id="T2:U27">3</span>)</span> = <span class="mxinfo" id="T2:U28">0</span></span>;   <span class="comment">% 高度方向不补偿</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,190" id="srcline190">190</a></span><span class="line"><span class="mxinfo" id="T6:U29"><span class="var type1" id="S41T6U486">SingleFrameCompensate_k</span> = <span class="mxinfo" id="T6:U31"><span class="var type1" id="S49T6U488">InertialErr_k</span>*<span class="var type1" id="S44T2U489">compensateRate</span></span></span> ;  <span class="comment">% 单帧补偿量</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,191" id="srcline191">191</a></span><span class="line"><span class="mxinfo" id="T6:U34"><span class="var type1" id="S43T6U492">InertialPositionNew_k</span> = <span class="mxinfo" id="T6:U36"><span class="var type1" id="S43T6U494">InertialPositionNew_k</span> + <span class="var type1" id="S41T6U495">SingleFrameCompensate_k</span></span></span>;   <span class="comment">% 补偿 ： 向光学靠近</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,192" id="srcline192">192</a></span><span class="line"><span class="mxinfo" id="T6:U39"><span class="var type1" id="S42T6U498">AccumulateCompensate_k</span> = <span class="mxinfo" id="T6:U41"><span class="var type1" id="S43T6U500">InertialPositionNew_k</span>-<span class="mxinfo" id="T6:U43"><span class="var type1" id="S46T67U502">InertialPosition_k</span>(:,<span class="mxinfo" id="T2:U45">2</span>)</span></span></span> ;  <span class="comment">% 累积补偿量</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,193" id="srcline193">193</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,194" id="srcline194">194</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,195" id="srcline195">195</a></span><span class="line"><span class="comment">%% 位移补偿</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,196" id="srcline196">196</a></span><span class="line"><span class="comment">%%% Input</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,197" id="srcline197">197</a></span><span class="line"><span class="comment">% trackedMakerPosition_InertialTime ： 马克点光学位置，按惯性时序存储</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,198" id="srcline198">198</a></span><span class="line"><span class="comment">% HipDisplacement ： Hip在北东地下的位置 （由 BVH 得到）</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,199" id="srcline199">199</a></span><span class="line"><span class="comment">% InertialPosition： 惯性系与马克点安装位置对应关节的位置（安装在头上时，InertialPosition 为惯性头的位置）</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,200" id="srcline200">200</a></span><span class="line"><span class="comment">%%% Output</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,201" id="srcline201">201</a></span><span class="line"><span class="comment">% InertialPositionNew ： 补偿后惯性的位置</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,202" id="srcline202">202</a></span><span class="line"><span class="comment">% HipDisplacementNew： 补偿后Hip的位置</span></span></span>
</pre>
