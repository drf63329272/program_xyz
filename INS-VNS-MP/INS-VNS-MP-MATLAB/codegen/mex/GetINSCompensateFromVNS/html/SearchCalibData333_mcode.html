<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="80,6" id="srcline6">  6</a></span><span class="line"><span class="keyword">function</span> [ <span class="var type1" id="S2T56U3">INSVNSCalib_VS_k</span>,<span class="var type1" id="S3T2U4">Calib_N_New</span>,<span class="var type1" id="S4T2U5">IsCalibDataEnough</span>,<span class="var type1" id="S5T59U6">dX_Vision</span> ] = SearchCalibData<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,7" id="srcline7">  7</a></span><span class="line">            ( <span class="mxinfo" id="T56:U5"><span class="mxinfo" id="T56:U6"><span class="var type1" id="S2T56U9">INSVNSCalib_VS_k</span></span></span>,<span class="var type1" id="S6T2U10">Calib_N_Last</span>,<span class="var type1" id="S7T57U11">trackedMarkerVelocity</span>,<span class="var type1" id="S8T50U12">trackedMakerPosition</span>,<span class="var type1" id="S9T2U13">vision_k</span>,<span class="var type1" id="S10T43U14">INSVNSCalibSet</span> )</span></span>
<span class="srcline"><span class="lineno"><a href="80,8" id="srcline8">  8</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="80,9" id="srcline9">  9</a></span><span class="line"><span class="keyword">global</span>  <span class="var type0" id="S11T0U16">visionFre</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,10" id="srcline10"> 10</a></span><span class="line">coder.extrinsic(<span class="string">'fprintf'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="80,11" id="srcline11"> 11</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="80,12" id="srcline12"> 12</a></span><span class="line"><span class="mxinfo" id="T2:U13"><span class="var type1" id="S4T2U25">IsCalibDataEnough</span> = <span class="mxinfo" id="T2:U15">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="80,13" id="srcline13"> 13</a></span><span class="line"><span class="mxinfo" id="T59:U16"><span class="var type1" id="S5T59U29">dX_Vision</span> = <span class="mxinfo" id="T54:U18">[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="80,14" id="srcline14"> 14</a></span><span class="line"><span class="mxinfo" id="T2:U19"><span class="var type1" id="S3T2U34">Calib_N_New</span> = <span class="var type1" id="S6T2U35">Calib_N_Last</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="80,15" id="srcline15"> 15</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T14:U22">isnan( <span class="mxinfo" id="T2:U23"><span class="var type1" id="S7T57U42">trackedMarkerVelocity</span>(<span class="mxinfo" id="T2:U25">1</span>,<span class="var type1" id="S9T2U44">vision_k</span>)</span> )</span> || <span class="mxinfo" id="T14:U27">isnan( <span class="mxinfo" id="T2:U28"><span class="var type1" id="S8T50U48">trackedMakerPosition</span>(<span class="mxinfo" id="T2:U30">1</span>,<span class="var type1" id="S9T2U50">vision_k</span>)</span> )</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,16" id="srcline16"> 16</a></span><span class="line">    <span class="keyword">return</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="80,17" id="srcline17"> 17</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,18" id="srcline18"> 18</a></span><span class="line"><span class="comment">%% 阈值参数设置</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,19" id="srcline19"> 19</a></span><span class="line"><span class="mxinfo" id="T2:U32"><span class="var type1" id="S14T2U54">MaxTime_Calib</span> = <span class="mxinfo" id="T2:U34"><span class="var type1" id="S10T43U56">INSVNSCalibSet</span>.MaxTime_Calib</span></span> ;  <span class="comment">% sec  用于标定的数据的最长时间</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,20" id="srcline20"> 20</a></span><span class="line"><span class="mxinfo" id="T2:U36"><span class="var type1" id="S15T2U60">MaxVXY_DirectionChange_Calib</span> = <span class="mxinfo" id="T2:U38"><span class="var type1" id="S10T43U62">INSVNSCalibSet</span>.MaxVXY_DirectionChange_Calib</span></span> ;     <span class="comment">% ° XY平面速度方向变化最大范围</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,21" id="srcline21"> 21</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="80,22" id="srcline22"> 22</a></span><span class="line"><span class="mxinfo" id="T2:U40"><span class="var type1" id="S16T2U66">MaxN_Calib</span> = <span class="mxinfo" id="T2:U42">fix(<span class="mxinfo" id="T2:U43"><span class="var type1" id="S14T2U70">MaxTime_Calib</span>*<span class="var type1" id="S11T2U71">visionFre</span></span>)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="80,23" id="srcline23"> 23</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="80,24" id="srcline24"> 24</a></span><span class="line"><span class="comment">%% 从上一段位移差数据之后开始搜索</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,25" id="srcline25"> 25</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T14:U46"><span class="var type1" id="S6T2U75">Calib_N_Last</span>&gt;<span class="mxinfo" id="T2:U48">0</span></span> </span></span>
<span class="srcline"><span class="lineno"><a href="80,26" id="srcline26"> 26</a></span><span class="line">    <span class="mxinfo" id="T2:U49"><span class="var type1" id="S18T2U79">LastEnd_k</span> = <span class="mxinfo" id="T2:U51"><span class="var type1" id="S2T56U81">INSVNSCalib_VS_k</span>(<span class="mxinfo" id="T2:U53">2</span>,<span class="var type1" id="S6T2U83">Calib_N_Last</span>)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="80,27" id="srcline27"> 27</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,28" id="srcline28"> 28</a></span><span class="line">    <span class="mxinfo" id="T2:U55"><span class="var type1" id="S18T2U87">LastEnd_k</span> = <span class="mxinfo" id="T2:U57">0</span></span> ;  <span class="comment">% 第一次搜索</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,29" id="srcline29"> 29</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,30" id="srcline30"> 30</a></span><span class="line"><span class="comment">% 从 LastEnd_k+1 搜索到 vision_k</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,31" id="srcline31"> 31</a></span><span class="line"><span class="mxinfo" id="T2:U58"><span class="var type1" id="S19T2U91">search_k</span> = <span class="var type1" id="S9T2U92">vision_k</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="80,32" id="srcline32"> 32</a></span><span class="line"><span class="comment">%% 搜索末尾点</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,33" id="srcline33"> 33</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="80,34" id="srcline34"> 34</a></span><span class="line"><span class="mxinfo" id="T2:U61"><span class="var type1" id="S20T2U95">search_k_end</span> = <span class="mxinfo" id="T2:U63">NaN</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="80,35" id="srcline35"> 35</a></span><span class="line"><span class="keyword">while</span> <span class="mxinfo" id="T14:U64"><span class="var type1" id="S19T2U100">search_k</span> &gt; <span class="var type1" id="S18T2U101">LastEnd_k</span></span>   </span></span>
<span class="srcline"><span class="lineno"><a href="80,36" id="srcline36"> 36</a></span><span class="line">    <span class="mxinfo" id="T2:U67"><span class="var type1" id="S22T2U104">IsCalibDataVelocityOK</span> = <span class="mxinfo" id="T2:U69"><span class="fcn" id="F334N37:B106">CalibDataVelocityJudge</span>( <span class="mxinfo" id="T58:U70"><span class="var type1" id="S7T57U108">trackedMarkerVelocity</span>(:,<span class="var type1" id="S9T2U110">vision_k</span>)</span>,<span class="var type1" id="S10T43U111">INSVNSCalibSet</span> )</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="80,37" id="srcline37"> 37</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T14:U74"><span class="var type1" id="S22T2U115">IsCalibDataVelocityOK</span> == <span class="mxinfo" id="T2:U76">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="80,38" id="srcline38"> 38</a></span><span class="line">        <span class="mxinfo" id="T2:U77"><span class="var type1" id="S20T2U119">search_k_end</span> = <span class="var type1" id="S19T2U120">search_k</span></span> ; <span class="comment">% 从最新的数据开始搜索，得到第一个OK的点作为末尾点</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,39" id="srcline39"> 39</a></span><span class="line"><span class="comment">%         fprintf('search_k_end = %d \n ',search_k_end)</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,40" id="srcline40"> 40</a></span><span class="line">        <span class="keyword">break</span>; </span></span>
<span class="srcline"><span class="lineno"><a href="80,41" id="srcline41"> 41</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,42" id="srcline42"> 42</a></span><span class="line">    <span class="mxinfo" id="T2:U80"><span class="var type1" id="S19T2U124">search_k</span> = <span class="mxinfo" id="T2:U82"><span class="var type1" id="S19T2U126">search_k</span>-<span class="mxinfo" id="T2:U84">1</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="80,43" id="srcline43"> 43</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,44" id="srcline44"> 44</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T14:U85">isnan(<span class="var type1" id="S20T2U132">search_k_end</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,45" id="srcline45"> 45</a></span><span class="line">    <span class="keyword">return</span>; <span class="comment">% 搜索失败</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,46" id="srcline46"> 46</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,47" id="srcline47"> 47</a></span><span class="line"><span class="comment">%% 搜索起点</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,48" id="srcline48"> 48</a></span><span class="line"><span class="mxinfo" id="T2:U87"><span class="var type1" id="S24T2U136">search_k_start</span> = <span class="mxinfo" id="T2:U89">NaN</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="80,49" id="srcline49"> 49</a></span><span class="line"><span class="keyword">while</span> <span class="mxinfo" id="T14:U90"><span class="var type1" id="S19T2U142">search_k</span> &gt; <span class="var type1" id="S18T2U143">LastEnd_k</span></span>  &amp;&amp;  <span class="mxinfo" id="T14:U93">(<span class="mxinfo" id="T2:U94"><span class="mxinfo" id="T2:U95"><span class="var type1" id="S20T2U148">search_k_end</span>-<span class="var type1" id="S19T2U149">search_k</span></span>+<span class="mxinfo" id="T2:U98">1</span></span>)&lt;<span class="var type1" id="S16T2U151">MaxN_Calib</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="80,50" id="srcline50"> 50</a></span><span class="line">    <span class="mxinfo" id="T2:U100"><span class="var type1" id="S22T2U154">IsCalibDataVelocityOK</span> = <span class="mxinfo" id="T2:U102"><span class="fcn" id="F334N37:B156">CalibDataVelocityJudge</span>( <span class="mxinfo" id="T58:U103"><span class="var type1" id="S7T57U158">trackedMarkerVelocity</span>(:,<span class="var type1" id="S9T2U160">vision_k</span>)</span>,<span class="var type1" id="S10T43U161">INSVNSCalibSet</span> )</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="80,51" id="srcline51"> 51</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T14:U107"><span class="var type1" id="S22T2U165">IsCalibDataVelocityOK</span> == <span class="mxinfo" id="T2:U109">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="80,52" id="srcline52"> 52</a></span><span class="line">        <span class="mxinfo" id="T2:U110"><span class="var type1" id="S25T2U169">search_k_start_temp</span> = <span class="mxinfo" id="T2:U112"><span class="var type1" id="S19T2U171">search_k</span>+<span class="mxinfo" id="T2:U114">1</span></span></span> ; <span class="comment">% 得到速度大小满足条件的 起始点，再判断位移长度</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,53" id="srcline53"> 53</a></span><span class="line">        <span class="mxinfo" id="T2:U115">[ <span class="var type1" id="S26T2U176">IsCalibDataDistanceOK</span>,<span class="var type1" id="S27T2U177">dX_xyNorm_VS</span> ] = <span class="fcn" id="F335N36:B179">CalibDataDistanceJudge</span>( <span class="var type1" id="S8T50U180">trackedMakerPosition</span>,<span class="var type1" id="S25T2U181">search_k_start_temp</span>,<span class="var type1" id="S20T2U182">search_k_end</span>,<span class="var type1" id="S10T43U183">INSVNSCalibSet</span> )</span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="80,54" id="srcline54"> 54</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="80,55" id="srcline55"> 55</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo" id="T14:U122"><span class="var type1" id="S26T2U187">IsCalibDataDistanceOK</span>==<span class="mxinfo" id="T2:U124">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="80,56" id="srcline56"> 56</a></span><span class="line">            <span class="mxinfo" id="T2:U125"><span class="var type1" id="S24T2U191">search_k_start</span> = <span class="var type1" id="S25T2U192">search_k_start_temp</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="80,57" id="srcline57"> 57</a></span><span class="line">            <span class="keyword">break</span>; </span></span>
<span class="srcline"><span class="lineno"><a href="80,58" id="srcline58"> 58</a></span><span class="line">        <span class="keyword">end</span>         </span></span>
<span class="srcline"><span class="lineno"><a href="80,59" id="srcline59"> 59</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,60" id="srcline60"> 60</a></span><span class="line">    <span class="mxinfo" id="T2:U128"><span class="var type1" id="S19T2U196">search_k</span> = <span class="mxinfo" id="T2:U130"><span class="var type1" id="S19T2U198">search_k</span>-<span class="mxinfo" id="T2:U132">1</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="80,61" id="srcline61"> 61</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,62" id="srcline62"> 62</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T14:U133">isnan(<span class="var type1" id="S24T2U204">search_k_start</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,63" id="srcline63"> 63</a></span><span class="line">    <span class="keyword">return</span>; <span class="comment">% 搜索失败</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,64" id="srcline64"> 64</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,65" id="srcline65"> 65</a></span><span class="line"><span class="comment">%% 判断这段区间速度的角度变化是够小</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,66" id="srcline66"> 66</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="80,67" id="srcline67"> 67</a></span><span class="line"><span class="mxinfo" id="T51:U135"><span class="var type1" id="S29T51U208">VelocityDirection</span> = <span class="mxinfo" id="T51:U137"><span class="var type1" id="S7T57U210">trackedMarkerVelocity</span>( <span class="mxinfo" id="T2:U139">5</span>,<span class="mxinfo" id="T2:U140"><span class="var type1" id="S24T2U213">search_k_start</span>:<span class="var type1" id="S20T2U214">search_k_end</span></span> )</span></span>;  <span class="comment">% 速度方向</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,68" id="srcline68"> 68</a></span><span class="line"><span class="mxinfo" id="T2:U143"><span class="var type1" id="S30T2U217">VelocityDirectionRange</span> = <span class="mxinfo" id="T2:U145"><span class="mxinfo" id="T2:U146">max(<span class="var type1" id="S29T51U221">VelocityDirection</span>)</span> - <span class="mxinfo" id="T2:U148">min(<span class="var type1" id="S29T51U224">VelocityDirection</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="80,69" id="srcline69"> 69</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T14:U150"><span class="var type1" id="S30T2U228">VelocityDirectionRange</span> &gt; <span class="var type1" id="S15T2U229">MaxVXY_DirectionChange_Calib</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="80,70" id="srcline70"> 70</a></span><span class="line">    <span class="keyword">return</span>; <span class="comment">% 搜索失败  速度方向变化范围太大</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,71" id="srcline71"> 71</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,72" id="srcline72"> 72</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="80,73" id="srcline73"> 73</a></span><span class="line"><span class="comment">%% 搜索一段位移成功</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,74" id="srcline74"> 74</a></span><span class="line"><span class="mxinfo" id="T2:U153"><span class="var type1" id="S3T2U233">Calib_N_New</span> = <span class="mxinfo" id="T2:U155"><span class="var type1" id="S6T2U235">Calib_N_Last</span>+<span class="mxinfo" id="T2:U157">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="80,75" id="srcline75"> 75</a></span><span class="line"><span class="mxinfo" id="T45:U158"><span class="mxinfo" id="T45:U159"><span class="var type1" id="S2T56U240">INSVNSCalib_VS_k</span>(:,<span class="var type1" id="S3T2U242">Calib_N_New</span>)</span> = <span class="mxinfo" id="T45:U162">[<span class="var type1" id="S24T2U245">search_k_start</span>;<span class="var type1" id="S20T2U247">search_k_end</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="80,76" id="srcline76"> 76</a></span><span class="line"><span class="comment">%% 判断当前所有搜索的位移是否满足均匀特性</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,77" id="srcline77"> 77</a></span><span class="line"><span class="mxinfo" id="T2:U165">[ <span class="var type1" id="S4T2U251">IsCalibDataEnough</span>,<span class="var type1" id="S5T59U252">dX_Vision</span> ] = <span class="fcn" id="F348N38:B254">JudgeIsCalibDataEnough</span>( <span class="var type1" id="S2T56U255">INSVNSCalib_VS_k</span>,<span class="var type1" id="S3T2U256">Calib_N_New</span>,<span class="var type1" id="S8T50U257">trackedMakerPosition</span>,<span class="var type1" id="S10T43U258">INSVNSCalibSet</span> )</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="80,78" id="srcline78"> 78</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="80,79" id="srcline79"> 79</a></span><span class="line"><span class="mxinfo" id="T2:U172"><span class="var type1" id="S34T2U261">searchT</span> = <span class="mxinfo" id="T2:U174">(<span class="mxinfo" id="T2:U175"><span class="var type1" id="S20T2U265">search_k_end</span>-<span class="var type1" id="S24T2U266">search_k_start</span></span>)/<span class="var type1" id="S11T2U267">visionFre</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="80,80" id="srcline80"> 80</a></span><span class="line"><span class="comment">% fprintf( '\n 第%d段位移：[%d  %d]sec，  \n 角度范围 = %0.2f °，位移长度 = %0.2f m，\n   时间=%0.2f sec ，平均速度： %0.2f m/s \n',<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="80,81" id="srcline81"> 81</a></span><span class="line"><span class="comment">%     Calib_N_New,search_k_start/visionFre,search_k_end/visionFre,VelocityDirectionRange*180/pi,dX_xyNorm_VS,searchT,dX_xyNorm_VS/searchT );</span></span></span>
<span class="srcline"><span class="lineno"><a href="80,82" id="srcline82"> 82</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="80,83" id="srcline83"> 83</a></span><span class="line"><span class="comment">%% 判断搜索得到的位移数据够不够多，是否已经均匀分布</span></span></span>
</pre>
