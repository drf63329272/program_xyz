<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="33,1" id="srcline1"> 1</a></span><span class="line"><span class="comment">%% xyz 2015.6.1</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,2" id="srcline2"> 2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="33,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">%% 计算某个点的速度</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,4" id="srcline4"> 4</a></span><span class="line"><span class="comment">%% 得到 第 k 个点的位置后，计算的是第 k_calV 个点的速度（ k_calV = data_k-dN_CalV ;）</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,5" id="srcline5"> 5</a></span><span class="line"><span class="comment">% dT_CalV： 速度计算步长</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,6" id="srcline6"> 6</a></span><span class="line"><span class="comment">%  V(k) = (X(k+dN_CalV) - X(k-dN_CalV)) / (dT_CalV*2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,7" id="srcline7"> 7</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="33,8" id="srcline8"> 8</a></span><span class="line"><span class="comment">% fre： 频率</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,9" id="srcline9"> 9</a></span><span class="line"><span class="comment">% dT_CalV： 速度计算的步长时间</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,10" id="srcline10">10</a></span><span class="line"><span class="comment">% MinXYVNorm_CalAngle： 计算xy速度方向要求的最小xy速度模值</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,11" id="srcline11">11</a></span><span class="line"><span class="comment">% CalVFlag： 速度计算方法标志</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,12" id="srcline12">12</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="33,13" id="srcline13">13</a></span><span class="line"><span class="comment">%% Velocity_k</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,14" id="srcline14">14</a></span><span class="line"><span class="comment">% Velocity_k(1:3,1) : xyz三维的速度</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,15" id="srcline15">15</a></span><span class="line"><span class="comment">% Velocity_k(4,1) : xy平面速度的模</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,16" id="srcline16">16</a></span><span class="line"><span class="comment">% Velocity_k(5,1) : xy平面速度与正前方之间的夹角（模大于0.2m/s时才计算）</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,17" id="srcline17">17</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="33,18" id="srcline18">18</a></span><span class="line"><span class="comment">%% DataStore 数据存储格式</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,19" id="srcline19">19</a></span><span class="line"><span class="comment">% DataStore.IsLoopStore =0/1  是否循环存储</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,20" id="srcline20">20</a></span><span class="line"><span class="comment">% DataStore.BN   BufferN    缓存大小</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,21" id="srcline21">21</a></span><span class="line"><span class="comment">% DataStore.EN   EndN       结束序号</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,22" id="srcline22">22</a></span><span class="line"><span class="comment">% DataStore.SN   StartN     起始序号</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,23" id="srcline23">23</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="33,24" id="srcline24">24</a></span><span class="line"><span class="keyword">function</span> [ <span class="var type1" id="S2T54U3">Velocity_k</span>,<span class="var type1" id="S3T1U4">k_calV</span> ] = CalVelocity( <span class="var type1" id="S4T44U7">Position</span>,<span class="var type1" id="S5T2U8">data_k</span>,<span class="var type1" id="S6T1U9">fre</span>,<span class="var type1" id="S7T2U10">dT_CalV</span>,<span class="var type1" id="S8T2U11">MinXYVNorm_CalAngle</span>,<span class="mxinfo" id="T2:U8"><span class="var type2" id="S9T2V4U12">CalVFlag</span></span> )</span></span>
<span class="srcline"><span class="lineno"><a href="33,25" id="srcline25">25</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="33,26" id="srcline26">26</a></span><span class="line"><span class="comment">% 速度计算的步长个数</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,27" id="srcline27">27</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="33,28" id="srcline28">28</a></span><span class="line"><span class="mxinfo" id="T2:U10"><span class="var type1" id="S7T2U15">dT_CalV</span> = <span class="mxinfo" id="T2:U12">min(<span class="var type1" id="S7T2U18">dT_CalV</span>,<span class="mxinfo" id="T2:U14">0.2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="33,29" id="srcline29">29</a></span><span class="line"><span class="mxinfo" id="T1:U15"><span class="var type1" id="S11T1U22">dN_CalV</span> = <span class="mxinfo" id="T1:U17">fix(<span class="mxinfo" id="T1:U18"><span class="var type1" id="S7T2U26">dT_CalV</span>*<span class="var type1" id="S6T1U27">fre</span></span>)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="33,30" id="srcline30">30</a></span><span class="line"><span class="mxinfo" id="T1:U21"><span class="var type1" id="S11T1U30">dN_CalV</span> = <span class="mxinfo" id="T1:U23">max(<span class="var type1" id="S11T1U33">dN_CalV</span>,<span class="mxinfo" id="T2:U25">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="33,31" id="srcline31">31</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="33,32" id="srcline32">32</a></span><span class="line"><span class="mxinfo" id="T2:U26"><span class="var type1" id="S14T2U37">angleXY</span> = <span class="mxinfo" id="T2:U28">NaN</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="33,33" id="srcline33">33</a></span><span class="line"><span class="mxinfo" id="T54:U29"><span class="var type1" id="S2T54U42">Velocity_k</span> = <span class="mxinfo" id="T100:U31">NaN(<span class="mxinfo" id="T2:U32">5</span>,1)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="33,34" id="srcline34">34</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="33,35" id="srcline35">35</a></span><span class="line"><span class="comment">%% 计算速度： </span></span></span>
<span class="srcline"><span class="lineno"><a href="33,36" id="srcline36">36</a></span><span class="line"><span class="comment">% 计算第 k_calV 个数的速度：用 [ k_calV-dN_CalV, k_calV+dN_CalV  ] 的一段数据</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,37" id="srcline37">37</a></span><span class="line"><span class="comment">% 得到 data_k 数据后，计算第 data_k-dN_CalV 个数的速度</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,38" id="srcline38">38</a></span><span class="line"><span class="mxinfo" id="T1:U33"><span class="var type1" id="S3T1U49">k_calV</span> = <span class="mxinfo" id="T1:U35"><span class="var type1" id="S5T2U51">data_k</span>-<span class="var type1" id="S11T1U52">dN_CalV</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="33,39" id="srcline39">39</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="33,40" id="srcline40">40</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T3:U38"><span class="mxinfo" id="T1:U39"><span class="var type1" id="S3T1U58">k_calV</span>-<span class="var type1" id="S11T1U59">dN_CalV</span></span>&lt;<span class="mxinfo" id="T2:U42">1</span></span> || <span class="mxinfo" id="T3:U43"><span class="mxinfo" id="T1:U44"><span class="var type1" id="S3T1U63">k_calV</span>+<span class="var type1" id="S11T1U64">dN_CalV</span></span>&gt;<span class="mxinfo" id="T2:U47">length(<span class="var type1" id="S4T44U67">Position</span>)</span></span>    </span></span>
<span class="srcline"><span class="lineno"><a href="33,41" id="srcline41">41</a></span><span class="line">    <span class="keyword">return</span>; </span></span>
<span class="srcline"><span class="lineno"><a href="33,42" id="srcline42">42</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,43" id="srcline43">43</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="33,44" id="srcline44">44</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="33,45" id="srcline45">45</a></span><span class="line"><span class="comment">%% xyz三维的速度</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,46" id="srcline46">46</a></span><span class="line"><span class="keyword">switch</span> <span class="var type1" id="S9T2U70">CalVFlag</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,47" id="srcline47">47</a></span><span class="line">    <span class="keyword">case</span> 1</span></span>
<span class="srcline"><span class="lineno"><a href="33,48" id="srcline48">48</a></span><span class="line">        <span class="comment">%% 直接采用端区间端点起斜率</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,49" id="srcline49">49</a></span><span class="line">        <span class="var type0" id="S17T0U75">Position1</span> = <span class="var type0" id="S4T0U77">Position</span>( :,<span class="var type0" id="S3T0U80">k_calV</span>+<span class="var type0" id="S11T0U81">dN_CalV</span> ) ;</span></span>
<span class="srcline"><span class="lineno"><a href="33,50" id="srcline50">50</a></span><span class="line">        <span class="var type0" id="S18T0U84">Position2</span> = <span class="var type0" id="S4T0U86">Position</span>( :,<span class="var type0" id="S3T0U89">k_calV</span>-<span class="var type0" id="S11T0U90">dN_CalV</span> ) ;</span></span>
<span class="srcline"><span class="lineno"><a href="33,51" id="srcline51">51</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="33,52" id="srcline52">52</a></span><span class="line">    <span class="keyword">case</span> 2</span></span>
<span class="srcline"><span class="lineno"><a href="33,53" id="srcline53">53</a></span><span class="line">        <span class="comment">%% 采用 [k_calV-dN_CalV:k_calV-1 ]和[k_calV+1:k_calV+dN_CalV]的均值求斜率</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,54" id="srcline54">54</a></span><span class="line">        <span class="mxinfo" id="T48:U50"><span class="var type1" id="S19T48U95">Position1_A</span> = <span class="mxinfo" id="T48:U52"><span class="var type1" id="S4T44U97">Position</span>( :,<span class="mxinfo" id="T1:U54"><span class="mxinfo" id="T1:U55"><span class="var type1" id="S3T1U101">k_calV</span>+<span class="mxinfo" id="T2:U57">1</span></span>:<span class="mxinfo" id="T1:U58"><span class="var type1" id="S3T1U104">k_calV</span>+<span class="var type1" id="S11T1U105">dN_CalV</span></span></span> )</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="33,55" id="srcline55">55</a></span><span class="line">        <span class="mxinfo" id="T48:U61"><span class="var type1" id="S20T48U108">Position2_A</span> = <span class="mxinfo" id="T48:U63"><span class="var type1" id="S4T44U110">Position</span>( :,<span class="mxinfo" id="T1:U65"><span class="mxinfo" id="T1:U66"><span class="var type1" id="S3T1U114">k_calV</span>-<span class="var type1" id="S11T1U115">dN_CalV</span></span>:<span class="mxinfo" id="T1:U69"><span class="var type1" id="S3T1U117">k_calV</span>-<span class="mxinfo" id="T2:U71">1</span></span></span> )</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="33,56" id="srcline56">56</a></span><span class="line">        <span class="mxinfo" id="T45:U72"><span class="var type1" id="S17T45U121">Position1</span> = <span class="mxinfo" id="T45:U74">mean(<span class="var type1" id="S19T48U124">Position1_A</span>,2)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="33,57" id="srcline57">57</a></span><span class="line">        <span class="mxinfo" id="T45:U76"><span class="var type1" id="S18T45U128">Position2</span> = <span class="mxinfo" id="T45:U78">mean(<span class="var type1" id="S20T48U131">Position2_A</span>,2)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="33,58" id="srcline58">58</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,59" id="srcline59">59</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="33,60" id="srcline60">60</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T3:U80">isnan( <span class="mxinfo" id="T2:U81"><span class="var type1" id="S17T45U139">Position1</span>(<span class="mxinfo" id="T2:U83">1</span>)</span> )</span> || <span class="mxinfo" id="T3:U84">isnan( <span class="mxinfo" id="T2:U85"><span class="var type1" id="S18T45U144">Position2</span>(<span class="mxinfo" id="T2:U87">1</span>)</span> )</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,61" id="srcline61">61</a></span><span class="line">    <span class="mxinfo" id="T54:U88"><span class="var type1" id="S2T54U148">Velocity_k</span> = <span class="mxinfo" id="T100:U90">NaN(<span class="mxinfo" id="T2:U91">5</span>,1)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="33,62" id="srcline62">62</a></span><span class="line">    <span class="keyword">return</span>;  <span class="comment">% 计算速度的数据中有跟踪失败的点 </span></span></span>
<span class="srcline"><span class="lineno"><a href="33,63" id="srcline63">63</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,64" id="srcline64">64</a></span><span class="line"><span class="mxinfo" id="T54:U92"><span class="var type1" id="S2T54U156">Velocity_k</span> = <span class="mxinfo" id="T45:U94">( <span class="mxinfo" id="T45:U95"><span class="var type1" id="S17T45U160">Position1</span> - <span class="var type1" id="S18T45U161">Position2</span></span> ) / (<span class="mxinfo" id="T2:U98"><span class="var type1" id="S7T2U164">dT_CalV</span>*<span class="mxinfo" id="T2:U100">2</span></span>)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="33,65" id="srcline65">65</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="33,66" id="srcline66">66</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="33,67" id="srcline67">67</a></span><span class="line"><span class="comment">% 第四行存储xy平面速度的模</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,68" id="srcline68">68</a></span><span class="line"><span class="mxinfo" id="T2:U101"><span class="var type1" id="S23T2U168">trackedMarkerVelocity_xyNorm</span> = <span class="mxinfo" id="T2:U103">normest(<span class="mxinfo" id="T55:U104"><span class="var type1" id="S2T54U172">Velocity_k</span>(<span class="mxinfo" id="T53:U106"><span class="mxinfo" id="T2:U107">1</span>:<span class="mxinfo" id="T2:U108">2</span></span>)</span>)</span></span> ; </span></span>
<span class="srcline"><span class="lineno"><a href="33,69" id="srcline69">69</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="33,70" id="srcline70">70</a></span><span class="line"><span class="comment">% 第五行存储xy平面速度与正前方之间的夹角（模大于0.2m/s时才计算）</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,71" id="srcline71">71</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T3:U109"><span class="var type1" id="S23T2U179">trackedMarkerVelocity_xyNorm</span> &gt;  <span class="var type1" id="S8T2U180">MinXYVNorm_CalAngle</span></span> </span></span>
<span class="srcline"><span class="lineno"><a href="33,72" id="srcline72">72</a></span><span class="line">   <span class="mxinfo" id="T2:U112"><span class="var type1" id="S25T2U183">temp</span> =  <span class="mxinfo" id="T2:U114"><span class="mxinfo" id="T2:U115"><span class="mxinfo" id="T53:U116">[0 1]</span>*<span class="mxinfo" id="T55:U117"><span class="var type1" id="S2T54U191">Velocity_k</span>(<span class="mxinfo" id="T53:U119"><span class="mxinfo" id="T2:U120">1</span>:<span class="mxinfo" id="T2:U121">2</span></span>)</span></span> / <span class="var type1" id="S23T2U195">trackedMarkerVelocity_xyNorm</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="33,73" id="srcline73">73</a></span><span class="line">   <span class="mxinfo" id="T2:U123"><span class="var type1" id="S14T2U198">angleXY</span> = <span class="mxinfo" id="T2:U125">acos(<span class="var type1" id="S25T2U201">temp</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="33,74" id="srcline74">74</a></span><span class="line">   <span class="keyword">if</span> <span class="mxinfo" id="T3:U127"><span class="mxinfo" id="T2:U128"><span class="var type1" id="S2T54U206">Velocity_k</span>(<span class="mxinfo" id="T2:U130">1</span>)</span>&gt;<span class="mxinfo" id="T2:U131">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="33,75" id="srcline75">75</a></span><span class="line">       <span class="mxinfo" id="T2:U132"><span class="var type1" id="S14T2U211">angleXY</span> = <span class="mxinfo" id="T2:U134">-<span class="var type1" id="S14T2U213">angleXY</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="33,76" id="srcline76">76</a></span><span class="line">   <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,77" id="srcline77">77</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="33,78" id="srcline78">78</a></span><span class="line"><span class="mxinfo" id="T54:U136"><span class="var type1" id="S2T54U216">Velocity_k</span> = <span class="mxinfo" id="T54:U138">[ <span class="var type1" id="S2T54U219">Velocity_k</span>; <span class="var type1" id="S23T2U221">trackedMarkerVelocity_xyNorm</span>;<span class="var type1" id="S14T2U223">angleXY</span> ]</span></span>; </span></span>
</pre>
