<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="31,17" id="srcline17">17</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="31,18" id="srcline18">18</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="31,19" id="srcline19">19</a></span><span class="line"><span class="keyword">function</span> [ <span class="var type1" id="S2T44U3">data_WaveFlag</span>,<span class="var type1" id="S3T43U4">dataV</span>,<span class="var type1" id="S4T44U5">dataA_waveFront</span>,<span class="var type1" id="S5T44U6">dataA_waveBack</span>,<span class="var type1" id="S6T45U7">k_waves_OKLast</span> ] = AnalyzeWave<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,20" id="srcline20">20</a></span><span class="line">    ( <span class="var type1" id="S7T44U10">data</span>,<span class="var type1" id="S8T2U11">k_data</span>,<span class="var type1" id="S9T1U12">fre</span>,<span class="mxinfo" id="T43:U9"><span class="mxinfo" id="T43:U10"><span class="var type1" id="S3T43U13">dataV</span></span></span>,<span class="mxinfo" id="T44:U12"><span class="mxinfo" id="T44:U13"><span class="var type1" id="S2T44U14">data_WaveFlag</span></span></span>,<span class="mxinfo" id="T45:U15"><span class="mxinfo" id="T45:U16"><span class="var type1" id="S6T45U15">k_waves_OKLast</span></span></span>,<span class="mxinfo" id="T44:U18"><span class="mxinfo" id="T44:U19"><span class="var type1" id="S4T44U16">dataA_waveFront</span></span></span>,<span class="mxinfo" id="T44:U21"><span class="mxinfo" id="T44:U22"><span class="var type1" id="S5T44U17">dataA_waveBack</span></span></span>,<span class="var type1" id="S10T40U18">waveThreshold</span> )</span></span>
<span class="srcline"><span class="lineno"><a href="31,21" id="srcline21">21</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="31,22" id="srcline22">22</a></span><span class="line"><span class="mxinfo" id="T2:U25"><span class="var type1" id="S11T2U21">IsRecordWaveMiddle</span> = <span class="mxinfo" id="T2:U27">0</span></span>;  <span class="comment">% 是否记录波腰</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,23" id="srcline23">23</a></span><span class="line"><span class="comment">%% 预设输出</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,24" id="srcline24">24</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="31,25" id="srcline25">25</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="31,26" id="srcline26">26</a></span><span class="line"><span class="comment">%% 读参数设置</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,27" id="srcline27">27</a></span><span class="line"><span class="mxinfo" id="T2:U28"><span class="var type1" id="S12T2U25">adjacentT</span> = <span class="mxinfo" id="T2:U30"><span class="var type1" id="S10T40U27">waveThreshold</span>.adjacentT</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="31,28" id="srcline28">28</a></span><span class="line"><span class="mxinfo" id="T1:U32"><span class="var type1" id="S13T1U31">adjacentN</span> = <span class="mxinfo" id="T1:U34">fix(<span class="mxinfo" id="T1:U35"><span class="var type1" id="S12T2U35">adjacentT</span>*<span class="var type1" id="S9T1U36">fre</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="31,29" id="srcline29">29</a></span><span class="line"><span class="mxinfo" id="T2:U38"><span class="var type1" id="S15T2U39">waveThreshold_Min_dataA</span> = <span class="mxinfo" id="T2:U40"><span class="var type1" id="S10T40U41">waveThreshold</span>.waveThreshold_Min_dataA</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="31,30" id="srcline30">30</a></span><span class="line"><span class="mxinfo" id="T2:U42"><span class="var type1" id="S16T2U45">MinWaveData</span> = <span class="mxinfo" id="T2:U44"><span class="var type1" id="S10T40U47">waveThreshold</span>.MinWaveData</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="31,31" id="srcline31">31</a></span><span class="line"><span class="mxinfo" id="T2:U46"><span class="var type1" id="S17T2U51">dT_CalV</span> = <span class="mxinfo" id="T2:U48"><span class="var type1" id="S10T40U53">waveThreshold</span>.dT_CalV</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="31,32" id="srcline32">32</a></span><span class="line"><span class="mxinfo" id="T2:U50"><span class="var type1" id="S18T2U57">MinXYVNorm_CalAngle</span> = <span class="mxinfo" id="T2:U52"><span class="var type1" id="S10T40U59">waveThreshold</span>.MinXYVNorm_CalAngle</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="31,33" id="srcline33">33</a></span><span class="line"> <span class="comment">%% 计算速度</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,34" id="srcline34">34</a></span><span class="line">   <span class="mxinfo" id="T54:U54">[ <span class="var type1" id="S19T54U64">Velocity_k</span>,<span class="var type1" id="S20T1U65">k_calV</span> ] = <span class="fcn" id="F83N7:B67">CalVelocity</span>( <span class="var type1" id="S7T44U68">data</span>,<span class="var type1" id="S8T2U69">k_data</span>,<span class="var type1" id="S9T1U70">fre</span>,<span class="var type1" id="S17T2U71">dT_CalV</span>,<span class="var type1" id="S18T2U72">MinXYVNorm_CalAngle</span>,2 )</span> ; <span class="comment">% 采用法2求速度</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,35" id="srcline35">35</a></span><span class="line">   <span class="keyword">if</span> <span class="mxinfo" id="T3:U62"><span class="var type1" id="S20T1U78">k_calV</span>&gt;<span class="mxinfo" id="T2:U64">0</span></span>  &amp;&amp; <span class="mxinfo" id="T3:U65">~<span class="mxinfo" id="T3:U66">isnan(<span class="mxinfo" id="T2:U67"><span class="var type1" id="S19T54U84">Velocity_k</span>(<span class="mxinfo" id="T2:U69">1</span>)</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="31,36" id="srcline36">36</a></span><span class="line">        <span class="mxinfo" id="T100:U70"><span class="mxinfo" id="T100:U71"><span class="var type1" id="S3T43U89">dataV</span>(:,<span class="var type1" id="S20T1U91">k_calV</span>)</span> = <span class="var type1" id="S19T54U92">Velocity_k</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="31,37" id="srcline37">37</a></span><span class="line">   <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,38" id="srcline38">38</a></span><span class="line">   <span class="comment">%% 判断 第 k_wave_i = k_calV - adjacentN; 个点的 波峰波谷特征</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,39" id="srcline39">39</a></span><span class="line">   <span class="mxinfo" id="T45:U75">[ <span class="var type1" id="S23T45U96">WaveFlag_k</span>,<span class="var type1" id="S24T57U97">k_waves</span>,<span class="var type1" id="S25T59U98">data_Acc_k_wave</span> ] = <span class="fcn" id="F198N10:B100">FindCrestThrough</span>( <span class="var type1" id="S7T44U101">data</span>,<span class="var type1" id="S9T1U102">fre</span>,<span class="var type1" id="S3T43U103">dataV</span>,<span class="var type1" id="S20T1U104">k_calV</span>,<span class="var type1" id="S13T1U105">adjacentN</span>,<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="31,40" id="srcline40">40</a></span><span class="line"><span class="mxinfo" id="T45:U75">       <span class="var type1" id="S15T2U106">waveThreshold_Min_dataA</span>,<span class="var type1" id="S16T2U107">MinWaveData</span> )</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="31,41" id="srcline41">41</a></span><span class="line">   <span class="comment">% 第 k_waves(i) 个点判断成功后，后续的 adjacentN 个点就不再判断（不然可能会出现误判反而覆盖的现象）</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,42" id="srcline42">42</a></span><span class="line">   <span class="keyword">for</span> <span class="var type1" id="S27T2U110">i</span>=<span class="mxinfo" id="T2:U87">1</span>:3       </span></span>
<span class="srcline"><span class="lineno"><a href="31,43" id="srcline43">43</a></span><span class="line">       <span class="keyword">if</span> <span class="mxinfo" id="T3:U88"><span class="mxinfo" id="T1:U89"><span class="var type1" id="S24T57U119">k_waves</span>(<span class="var type1" id="S27T2U120">i</span>)</span>&gt;<span class="mxinfo" id="T2:U92">0</span></span> &amp;&amp; <span class="mxinfo" id="T3:U93"><span class="mxinfo" id="T1:U94"><span class="var type1" id="S24T57U124">k_waves</span>(<span class="var type1" id="S27T2U125">i</span>)</span>~=<span class="mxinfo" id="T2:U97"><span class="var type1" id="S6T45U127">k_waves_OKLast</span>(<span class="var type1" id="S27T2U128">i</span>)</span></span>   <span class="comment">% 不是之前判断OK的点</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,44" id="srcline44">44</a></span><span class="line">           <span class="mxinfo" id="T2:U100"><span class="mxinfo" id="T2:U101"><span class="var type1" id="S2T44U132">data_WaveFlag</span>(<span class="var type1" id="S27T2U133">i</span>,<span class="mxinfo" id="T1:U104"><span class="var type1" id="S24T57U135">k_waves</span>(<span class="var type1" id="S27T2U136">i</span>)</span>)</span> = <span class="mxinfo" id="T2:U107"><span class="var type1" id="S23T45U138">WaveFlag_k</span>(<span class="var type1" id="S27T2U139">i</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="31,45" id="srcline45">45</a></span><span class="line">           <span class="mxinfo" id="T2:U110"><span class="mxinfo" id="T2:U111"><span class="var type1" id="S4T44U143">dataA_waveFront</span>(<span class="var type1" id="S27T2U144">i</span>,<span class="mxinfo" id="T1:U114"><span class="var type1" id="S24T57U146">k_waves</span>(<span class="var type1" id="S27T2U147">i</span>)</span>)</span> = <span class="mxinfo" id="T2:U117"><span class="var type1" id="S25T59U149">data_Acc_k_wave</span>(<span class="var type1" id="S27T2U150">i</span>,<span class="mxinfo" id="T2:U120">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="31,46" id="srcline46">46</a></span><span class="line">           <span class="mxinfo" id="T2:U121"><span class="mxinfo" id="T2:U122"><span class="var type1" id="S5T44U155">dataA_waveBack</span>(<span class="var type1" id="S27T2U156">i</span>,<span class="mxinfo" id="T1:U125"><span class="var type1" id="S24T57U158">k_waves</span>(<span class="var type1" id="S27T2U159">i</span>)</span>)</span> = <span class="mxinfo" id="T2:U128"><span class="var type1" id="S25T59U161">data_Acc_k_wave</span>(<span class="var type1" id="S27T2U162">i</span>,<span class="mxinfo" id="T2:U131">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="31,47" id="srcline47">47</a></span><span class="line">           <span class="comment">%% 寻找波峰波谷中间点</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,48" id="srcline48">48</a></span><span class="line">           <span class="keyword">if</span> ~<span class="mxinfo" id="T3:U132">isnan(<span class="mxinfo" id="T2:U133"><span class="var type1" id="S23T45U171">WaveFlag_k</span>(<span class="var type1" id="S27T2U172">i</span>)</span>)</span> &amp;&amp; <span class="var type1" id="S11T2U174">IsRecordWaveMiddle</span> == 1  <span class="comment">% 是波峰/波谷</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,49" id="srcline49">49</a></span><span class="line">               <span class="keyword">if</span> <span class="var type0" id="S6T0U180">k_waves_OKLast</span>(<span class="var type0" id="S27T0U181">i</span>)&gt;0 </span></span>
<span class="srcline"><span class="lineno"><a href="31,50" id="srcline50">50</a></span><span class="line">                   <span class="comment">% 波峰波谷相邻</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,51" id="srcline51">51</a></span><span class="line">                   <span class="var type0" id="S28T0U185">k1</span> = <span class="var type0" id="S6T0U187">k_waves_OKLast</span>(<span class="var type0" id="S27T0U188">i</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="31,52" id="srcline52">52</a></span><span class="line">                   <span class="var type0" id="S29T0U191">k2</span> = <span class="var type0" id="S24T0U193">k_waves</span>(<span class="var type0" id="S27T0U194">i</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="31,53" id="srcline53">53</a></span><span class="line">                  <span class="keyword">if</span>  size(<span class="var type0" id="S7T0U202">data</span>,2)&gt;=<span class="var type0" id="S28T0U204">k1</span> &amp;&amp; ~isnan(<span class="var type0" id="S7T0U209">data</span>(<span class="var type0" id="S27T0U210">i</span>,<span class="var type0" id="S28T0U211">k1</span>)) &amp;&amp; sign(<span class="var type0" id="S7T0U217">data</span>(<span class="var type0" id="S27T0U218">i</span>,<span class="var type0" id="S28T0U219">k1</span>)) * sign( <span class="var type0" id="S7T0U223">data</span>(<span class="var type0" id="S27T0U224">i</span>,<span class="var type0" id="S29T0U225">k2</span>) ) == -1</span></span>
<span class="srcline"><span class="lineno"><a href="31,54" id="srcline54">54</a></span><span class="line">                        <span class="comment">% 在 k_waves_OKLast(i) 到 k_waves(i) 搜索中间点                                   </span></span></span>
<span class="srcline"><span class="lineno"><a href="31,55" id="srcline55">55</a></span><span class="line">                        <span class="var type0" id="S32T0U230">dataV_Search</span> = <span class="var type0" id="S3T0U232">dataV</span>(<span class="var type0" id="S27T0U233">i</span>,<span class="var type0" id="S28T0U236">k1</span>+1:<span class="var type0" id="S29T0U239">k2</span>-1);</span></span>
<span class="srcline"><span class="lineno"><a href="31,56" id="srcline56">56</a></span><span class="line">                        <span class="comment">% 要求 dataV_Search 全大于0  或全小于0</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,57" id="srcline57">57</a></span><span class="line">                        <span class="keyword">if</span> abs(sum(sign(<span class="var type0" id="S32T0U250">dataV_Search</span>))) &gt;= <span class="var type0" id="S29T0U255">k2</span>-<span class="var type0" id="S28T0U256">k1</span>-2+1-2</span></span>
<span class="srcline"><span class="lineno"><a href="31,58" id="srcline58">58</a></span><span class="line">                            <span class="var type0" id="S35T0U262">dataSearch</span> = abs(<span class="var type0" id="S7T0U266">data</span>(<span class="var type0" id="S27T0U267">i</span>,<span class="var type0" id="S28T0U269">k1</span>:<span class="var type0" id="S29T0U270">k2</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="31,59" id="srcline59">59</a></span><span class="line">                            [<span class="var type0" id="S36T0U274">min_dataAbs</span>,<span class="var type0" id="S37T0U275">min_k</span>] = min(<span class="var type0" id="S35T0U278">dataSearch</span>,[],2);</span></span>
<span class="srcline"><span class="lineno"><a href="31,60" id="srcline60">60</a></span><span class="line">                            <span class="var type0" id="S2T0U285">data_WaveFlag</span>(<span class="var type0" id="S27T0U286">i</span>,<span class="var type0" id="S37T0U289">min_k</span>+<span class="var type0" id="S28T0U290">k1</span>-1) = 0;   <span class="comment">%  中间点 搜索OK</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,61" id="srcline61">61</a></span><span class="line">                        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,62" id="srcline62">62</a></span><span class="line">                  <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,63" id="srcline63">63</a></span><span class="line">               <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,64" id="srcline64">64</a></span><span class="line">           <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,65" id="srcline65">65</a></span><span class="line">       <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,66" id="srcline66">66</a></span><span class="line">       </span></span>
<span class="srcline"><span class="lineno"><a href="31,67" id="srcline67">67</a></span><span class="line">       </span></span>
<span class="srcline"><span class="lineno"><a href="31,68" id="srcline68">68</a></span><span class="line">       <span class="comment">% 更新上一时刻 判断成功的位置</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,69" id="srcline69">69</a></span><span class="line">       <span class="keyword">if</span> <span class="mxinfo" id="T3:U137">~<span class="mxinfo" id="T3:U138">isnan(<span class="mxinfo" id="T2:U139"><span class="var type1" id="S23T45U299">WaveFlag_k</span>(<span class="var type1" id="S27T2U300">i</span>)</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="31,70" id="srcline70">70</a></span><span class="line">           <span class="mxinfo" id="T2:U142"><span class="mxinfo" id="T2:U143"><span class="var type1" id="S6T45U304">k_waves_OKLast</span>(<span class="var type1" id="S27T2U305">i</span>)</span> = <span class="mxinfo" id="T1:U146"><span class="var type1" id="S24T57U307">k_waves</span>(<span class="var type1" id="S27T2U308">i</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="31,71" id="srcline71">71</a></span><span class="line">       <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="31,72" id="srcline72">72</a></span><span class="line">   <span class="keyword"><span class="keyword">end</span></span></span></span>
</pre>
