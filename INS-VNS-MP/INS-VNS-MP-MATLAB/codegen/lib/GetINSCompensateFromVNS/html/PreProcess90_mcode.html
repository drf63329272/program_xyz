<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,278" id="srcline278">278</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,279" id="srcline279">279</a></span><span class="line"><span class="comment">%% 视觉位置预处理</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,280" id="srcline280">280</a></span><span class="line"><span class="comment">% 1）将视觉数据  从视觉世界坐标系 转到 北东地坐标系</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,281" id="srcline281">281</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S77T1U923">otherMakers</span> = PreProcess( <span class="mxinfo" id="T1:U2"><span class="mxinfo" id="T1:U3"><span class="var type1" id="S77T1U926">otherMakers</span></span></span>,<span class="var type1" id="S78T6U927">BodyDirection</span>  )</span></span>
<span class="srcline"><span class="lineno"><a href="1,282" id="srcline282">282</a></span><span class="line">coder.inline(<span class="string">'never'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,283" id="srcline283">283</a></span><span class="line"><span class="keyword">global</span> <span class="var type0" id="S80T0U935">CalStartVN</span> <span class="var type0" id="S81T0U936">CalEndVN</span> </span></span>
<span class="srcline"><span class="lineno"><a href="1,284" id="srcline284">284</a></span><span class="line"><span class="keyword">persistent</span> <span class="var type1" id="S82T6U938">VisualP_t0</span>  <span class="comment">% 0时刻的视觉位置</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,285" id="srcline285">285</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T19:U7"><span class="mxinfo" id="T19:U8">isempty(<span class="var type0" id="S82T0U943">VisualP_t0</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,286" id="srcline286">286</a></span><span class="line">   <span class="mxinfo" id="T6:U9"><span class="var type1" id="S82T6U946">VisualP_t0</span> = <span class="mxinfo" id="T6:U11">zeros(<span class="mxinfo" id="T2:U12">3</span>,1)</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,287" id="srcline287">287</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,288" id="srcline288">288</a></span><span class="line"><span class="comment">%% 先转到北东地的同名坐标系</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,289" id="srcline289">289</a></span><span class="line"><span class="mxinfo" id="T28:U13"><span class="var type1" id="S85T28U953">Cv_r1</span> = <span class="mxinfo" id="T28:U15">[ 0 0 1; -1 0 0; 0 -1 0 ]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,290" id="srcline290">290</a></span><span class="line"><span class="comment">% dbstop in BodyDirection2Cr_r1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,291" id="srcline291">291</a></span><span class="line"><span class="mxinfo" id="T28:U16"><span class="var type1" id="S86T28U971">Cr_r1</span> = <span class="mxinfo" id="T28:U18"><span class="fcn" id="F57N11:B973">BodyDirection2Cr_r1</span>( <span class="var type1" id="S78T6U974">BodyDirection</span> )</span></span>;   <span class="comment">%   （法1）    要求人朝视觉标定标定的世界坐标系进行对准</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,292" id="srcline292">292</a></span><span class="line"><span class="mxinfo" id="T28:U20"><span class="var type1" id="S88T28U977">Cvr</span> = <span class="mxinfo" id="T28:U22"><span class="mxinfo" id="T28:U23"><span class="var type1" id="S86T28U980">Cr_r1</span>'</span> * <span class="mxinfo" id="T28:U25"><span class="var type1" id="S85T28U981">Cv_r1</span></span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,293" id="srcline293">293</a></span><span class="line"><span class="mxinfo" id="T28:U27"><span class="var type1" id="S88T28U984">Cvr</span> = <span class="mxinfo" id="T28:U29"><span class="var type1" id="S85T28U985">Cv_r1</span></span></span> ;         <span class="comment">%   （法2）    要求视觉世界坐标系的Z轴朝向正北</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,294" id="srcline294">294</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,295" id="srcline295">295</a></span><span class="line"><span class="comment">%% 先转到 惯性系 的北东地，并以视觉的初始点为原点（不处理高度）</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,296" id="srcline296">296</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,297" id="srcline297">297</a></span><span class="line"><span class="mxinfo" id="T6:U31"><span class="var type1" id="S89T6U988">Position_1</span> = <span class="mxinfo" id="T6:U33"><span class="mxinfo" id="T3:U34"><span class="mxinfo" id="T41:U35"><span class="var type1" id="S77T1U992">otherMakers</span>(<span class="mxinfo" id="T2:U37">1</span>)</span>.Position</span>(:,<span class="mxinfo" id="T2:U38">1</span>)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,298" id="srcline298">298</a></span><span class="line"><span class="mxinfo" id="T2:U39"><span class="mxinfo" id="T2:U40"><span class="var type1" id="S89T6U1000">Position_1</span>(<span class="mxinfo" id="T2:U42">2</span>)</span> = <span class="mxinfo" id="T2:U43">0</span></span> ;      <span class="comment">% 不处理高度方向</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,299" id="srcline299">299</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T19:U44"><span class="var type1" id="S80T4U1006">CalStartVN</span>==<span class="mxinfo" id="T2:U46">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,300" id="srcline300">300</a></span><span class="line">    <span class="mxinfo" id="T6:U47"><span class="var type1" id="S82T6U1010">VisualP_t0</span> = <span class="var type1" id="S89T6U1011">Position_1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,301" id="srcline301">301</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,302" id="srcline302">302</a></span><span class="line"><span class="mxinfo" id="T4:U50"><span class="keyword">for</span> <span class="var type1" id="S90T4U1014">k</span>=<span class="var type1" id="S80T4U1016">CalStartVN</span>:<span class="var type1" id="S81T4U1017">CalEndVN</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,303" id="srcline303">303</a></span><span class="line"><span class="mxinfo" id="T4:U50">    <span class="mxinfo" id="T3:U54"><span class="var type1" id="S91T3U1020">Position_k</span> = <span class="mxinfo" id="T3:U56"><span class="mxinfo" id="T41:U57"><span class="var type1" id="S77T1U1023">otherMakers</span>(<span class="var type1" id="S90T4U1024">k</span>)</span>.Position</span></span> ;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,304" id="srcline304">304</a></span><span class="line"><span class="mxinfo" id="T4:U50">    <span class="keyword">if</span> ~isempty(<span class="var type1" id="S91T3U1031">Position_k</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,305" id="srcline305">305</a></span><span class="line"><span class="comment"><span class="mxinfo" id="T4:U50">%         m = size(Position_k,2);</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,306" id="srcline306">306</a></span><span class="line"><span class="comment"><span class="mxinfo" id="T4:U50">%         position_offest = repmat(Position_1,1,m);</span>     </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,307" id="srcline307">307</a></span><span class="line"><span class="comment"><span class="mxinfo" id="T4:U50">%         Position_k_new = Cvr*(Position_k-position_offest) ;  % 从视觉世界坐标系 转到 北东地坐标系</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,308" id="srcline308">308</a></span><span class="line">          </span></span>
<span class="srcline"><span class="lineno"><a href="1,309" id="srcline309">309</a></span><span class="line"><span class="mxinfo" id="T4:U50">        <span class="mxinfo" id="T3:U61"><span class="var type1" id="S92T3U1034">Position_k_new</span> = <span class="mxinfo" id="T3:U63"><span class="mxinfo" id="T28:U64"><span class="var type1" id="S88T28U1036">Cvr</span></span>*<span class="var type1" id="S91T3U1037">Position_k</span></span></span>;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,310" id="srcline310">310</a></span><span class="line"><span class="mxinfo" id="T4:U50">        <span class="mxinfo" id="T3:U67"><span class="mxinfo" id="T3:U68"><span class="mxinfo" id="T41:U69"><span class="var type1" id="S77T1U1042">otherMakers</span>(<span class="var type1" id="S90T4U1043">k</span>)</span>.Position</span> = <span class="var type1" id="S92T3U1045">Position_k_new</span></span>;</span> </span></span>
<span class="srcline"><span class="lineno"><a href="1,311" id="srcline311">311</a></span><span class="line"><span class="mxinfo" id="T4:U50">    <span class="keyword">else</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,312" id="srcline312">312</a></span><span class="line"><span class="mxinfo" id="T4:U50">        <span class="var type0" id="S77T0U1051">otherMakers</span>(<span class="var type0" id="S90T0U1052">k</span>).Position = NaN(3,1);</span> </span></span>
<span class="srcline"><span class="lineno"><a href="1,313" id="srcline313">313</a></span><span class="line"><span class="mxinfo" id="T4:U50">    <span class="keyword">end</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,314" id="srcline314">314</a></span><span class="line"><span class="mxinfo" id="T4:U50">    <span class="mxinfo" id="T8:U73"><span class="mxinfo" id="T8:U74"><span class="mxinfo" id="T41:U75"><span class="var type1" id="S77T1U1062">otherMakers</span>(<span class="var type1" id="S90T4U1063">k</span>)</span>.CalculatedTime</span> = <span class="mxinfo" id="T8:U78"><span class="mxinfo" id="T8:U79"><span class="mxinfo" id="T41:U80"><span class="var type1" id="S77T1U1068">otherMakers</span>(<span class="var type1" id="S90T4U1069">k</span>)</span>.CalculatedTime</span>+<span class="mxinfo" id="T8:U83">1</span></span></span> ;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,315" id="srcline315">315</a></span><span class="line"><span class="mxinfo" id="T4:U50">    <span class="keyword">if</span> coder.target(<span class="string">'MATLAB'</span>) &amp;&amp; <span class="var type0" id="S77T0U1083">otherMakers</span>(<span class="var type0" id="S90T0U1084">k</span>).CalculatedTime~=1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,316" id="srcline316">316</a></span><span class="line"><span class="mxinfo" id="T4:U50">       fpritnf( <span class="string">'otherMakers(%0.0f).CalculatedTime = %0.0f\n'</span>,<span class="var type0" id="S90T0U1091">k</span>,<span class="var type0" id="S77T0U1094">otherMakers</span>(<span class="var type0" id="S90T0U1095">k</span>).CalculatedTime );</span> </span></span>
<span class="srcline"><span class="lineno"><a href="1,317" id="srcline317">317</a></span><span class="line"><span class="mxinfo" id="T4:U50">    <span class="keyword">end</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,318" id="srcline318">318</a></span><span class="line"><span class="mxinfo" id="T4:U50"><span class="keyword"><span class="keyword">end</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,319" id="srcline319">319</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,320" id="srcline320">320</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,321" id="srcline321">321</a></span><span class="line"><span class="comment">%% 根据 BodyDirection 求姿态</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,322" id="srcline322">322</a></span><span class="line"><span class="comment">% 符号有待验证！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,323" id="srcline323">323</a></span><span class="line"><span class="comment">%   BodyDirection  人朝北为 [1 0 0]</span></span></span>
</pre>
