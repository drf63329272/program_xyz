<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line"><span class="comment">%% 位移补偿</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line"><span class="comment">%%% Input</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line"><span class="comment">% trackedMakerPosition_InertialTime ： 马克点光学位置，按惯性时序存储</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line"><span class="comment">% HipDisplacement ： Hip在北东地下的位置 （由 BVH 得到）</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line"><span class="comment">% InertialPosition： 惯性系与马克点安装位置对应关节的位置（安装在头上时，InertialPosition 为惯性头的位置）</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line"><span class="comment">%%% Output</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line"><span class="comment">% InertialPositionNew ： 补偿后惯性的位置</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line"><span class="comment">% HipDisplacementNew： 补偿后Hip的位置</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line"><span class="keyword">function</span> [ <span class="var type1" id="S33T12U219">InertialPositionCompensate_out</span>,<span class="var type1" id="S34T12U220">HipDisplacementNew_out</span> ] = VNSCompensateINS<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line">( <span class="var type1" id="S35T2U223">compensateRate</span>,<span class="var type1" id="S36T12U224">trackedMakerPosition_InertialTime</span>,<span class="var type1" id="S37T12U225">HipDisplacement</span>,<span class="var type1" id="S38T12U226">InertialPosition</span> )</span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line">coder.inline(<span class="string">'never'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line">coder.extrinsic(<span class="string">'fprintf'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line">coder.extrinsic(<span class="string">'DrawCompensate'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line"><span class="keyword">global</span> <span class="var type0" id="S40T0U246">CalStartIN</span>  <span class="var type0" id="S41T0U247">CalEndIN</span> <span class="var type0" id="S42T0U248">IsOnLine</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line"><span class="comment">%% BVH 读取的个数 N_BVH 可能会比 N1 多几个</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line"><span class="mxinfo" id="T2:U7"><span class="var type1" id="S43T2U251">N_BVH</span> = <span class="mxinfo" id="T2:U9">size(<span class="var type1" id="S37T12U254">HipDisplacement</span>,2)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line"><span class="mxinfo" id="T2:U11"><span class="var type1" id="S45T2U258">N1</span> = <span class="mxinfo" id="T2:U13">size(<span class="var type1" id="S36T12U261">trackedMakerPosition_InertialTime</span>,2)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line"><span class="keyword">for</span> <span class="mxinfo" id="T2:U15"><span class="var type1" id="S46T2U265">k</span></span>=<span class="var type1" id="S45T2U268">N1</span>+1:<span class="var type1" id="S43T2U270">N_BVH</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line">    <span class="var type0" id="S36T0U274">trackedMakerPosition_InertialTime</span>(:,<span class="var type0" id="S46T0U276">k</span>) = <span class="var type0" id="S36T0U278">trackedMakerPosition_InertialTime</span>(:,<span class="var type0" id="S45T0U280">N1</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line">    <span class="var type0" id="S38T0U284">InertialPosition</span>(:,<span class="var type0" id="S46T0U286">k</span>) = <span class="var type0" id="S38T0U288">InertialPosition</span>(:,<span class="var type0" id="S45T0U290">N1</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line"><span class="comment">%% 先补偿 InertialPositionNew</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line"><span class="keyword">persistent</span> <span class="var type1" id="S47T12U292">InertialPositionCompensate</span>  <span class="var type1" id="S48T12U293">InertialPositionNew</span> <span class="var type1" id="S49T12U294">HipDisplacementNew</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T14:U22"><span class="mxinfo" id="T14:U23">isempty(<span class="var type0" id="S47T0U299">InertialPositionCompensate</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line">    <span class="mxinfo" id="T12:U24"><span class="var type1" id="S47T12U302">InertialPositionCompensate</span> = <span class="mxinfo" id="T12:U26">zeros(<span class="mxinfo" id="T2:U27">3</span>,<span class="mxinfo" id="T2:U28"><span class="var type1" id="S43T2U306">N_BVH</span></span>)</span></span>; <span class="comment">% 每一步的累积位移补偿量 记录</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line">    <span class="mxinfo" id="T12:U30"><span class="var type1" id="S48T12U309">InertialPositionNew</span> = <span class="mxinfo" id="T12:U32">NaN(<span class="mxinfo" id="T2:U33">3</span>,<span class="mxinfo" id="T2:U34"><span class="var type1" id="S43T2U313">N_BVH</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line">    <span class="mxinfo" id="T9:U36"><span class="mxinfo" id="T9:U37"><span class="var type1" id="S48T12U317">InertialPositionNew</span>(<span class="mxinfo" id="T2:U39">3</span>,:)</span> = <span class="mxinfo" id="T9:U40"><span class="var type1" id="S38T12U321">InertialPosition</span>(<span class="mxinfo" id="T2:U42">3</span>,:)</span></span>; <span class="comment">% 高度不补偿</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line">    <span class="mxinfo" id="T42:U43"><span class="mxinfo" id="T42:U44"><span class="var type1" id="S48T12U327">InertialPositionNew</span>(<span class="mxinfo" id="T39:U46"><span class="mxinfo" id="T2:U47">1</span>:<span class="mxinfo" id="T2:U48">2</span></span>,<span class="mxinfo" id="T2:U49">1</span>)</span> = <span class="mxinfo" id="T42:U50"><span class="var type1" id="S38T12U333">InertialPosition</span>(<span class="mxinfo" id="T39:U52"><span class="mxinfo" id="T2:U53">1</span>:<span class="mxinfo" id="T2:U54">2</span></span>,<span class="mxinfo" id="T2:U55">1</span>)</span></span> ;  <span class="comment">% 起始点选择惯性</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line">    <span class="mxinfo" id="T12:U56"><span class="var type1" id="S49T12U340">HipDisplacementNew</span> = <span class="var type1" id="S37T12U341">HipDisplacement</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line"><span class="keyword">persistent</span>  <span class="var type1" id="S53T67U343">InertialErr</span> <span class="var type1" id="S54T67U344">StepCompensate</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T14:U61"><span class="mxinfo" id="T14:U62">isempty(<span class="var type0" id="S54T0U349">StepCompensate</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line">    <span class="mxinfo" id="T67:U63"><span class="var type1" id="S53T67U352">InertialErr</span> = <span class="mxinfo" id="T67:U65">zeros(<span class="mxinfo" id="T2:U66">2</span>,<span class="mxinfo" id="T2:U67"><span class="var type1" id="S43T2U356">N_BVH</span></span>)</span></span>;       <span class="comment">% 实时记录补偿后的误差</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line">    <span class="mxinfo" id="T67:U69"><span class="var type1" id="S54T67U359">StepCompensate</span> = <span class="mxinfo" id="T67:U71">zeros(<span class="mxinfo" id="T2:U72">2</span>,<span class="mxinfo" id="T2:U73"><span class="var type1" id="S43T2U363">N_BVH</span></span>)</span></span>;  <span class="comment">% 单步补偿量</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S46T2U366">k</span> = <span class="mxinfo" id="T2:U76">max(<span class="mxinfo" id="T2:U77">2</span>,<span class="var type1" id="S40T2U371">CalStartIN</span>)</span> : <span class="var type1" id="S41T2U372">CalEndIN</span> </span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line">    <span class="comment">% 先用纯惯性递推</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line">    <span class="mxinfo" id="T42:U80"><span class="mxinfo" id="T42:U81"><span class="var type1" id="S48T12U376">InertialPositionNew</span>(<span class="mxinfo" id="T39:U83"><span class="mxinfo" id="T2:U84">1</span>:<span class="mxinfo" id="T2:U85">2</span></span>,<span class="var type1" id="S46T2U380">k</span>)</span> = <span class="mxinfo" id="T42:U87"><span class="mxinfo" id="T42:U88"><span class="var type1" id="S48T12U383">InertialPositionNew</span>(<span class="mxinfo" id="T39:U90"><span class="mxinfo" id="T2:U91">1</span>:<span class="mxinfo" id="T2:U92">2</span></span>,<span class="mxinfo" id="T2:U93"><span class="var type1" id="S46T2U388">k</span>-<span class="mxinfo" id="T2:U95">1</span></span>)</span>+( <span class="mxinfo" id="T42:U96"><span class="mxinfo" id="T42:U97"><span class="var type1" id="S38T12U393">InertialPosition</span>(<span class="mxinfo" id="T39:U99"><span class="mxinfo" id="T2:U100">1</span>:<span class="mxinfo" id="T2:U101">2</span></span>,<span class="var type1" id="S46T2U397">k</span>)</span>-<span class="mxinfo" id="T42:U103"><span class="var type1" id="S38T12U399">InertialPosition</span>(<span class="mxinfo" id="T39:U105"><span class="mxinfo" id="T2:U106">1</span>:<span class="mxinfo" id="T2:U107">2</span></span>,<span class="mxinfo" id="T2:U108"><span class="var type1" id="S46T2U404">k</span>-<span class="mxinfo" id="T2:U110">1</span></span>)</span></span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line">    <span class="comment">% 先求纯惯性为误差</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T14:U111">~<span class="mxinfo" id="T14:U112">isnan(<span class="mxinfo" id="T2:U113"><span class="var type1" id="S36T12U412">trackedMakerPosition_InertialTime</span>(<span class="mxinfo" id="T2:U115">1</span>,<span class="var type1" id="S46T2U414">k</span>)</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line">        <span class="mxinfo" id="T42:U117"><span class="mxinfo" id="T42:U118"><span class="var type1" id="S53T67U418">InertialErr</span>(:,<span class="var type1" id="S46T2U420">k</span>)</span> = <span class="mxinfo" id="T42:U121"><span class="mxinfo" id="T42:U122"><span class="var type1" id="S36T12U423">trackedMakerPosition_InertialTime</span>(<span class="mxinfo" id="T39:U124"><span class="mxinfo" id="T2:U125">1</span>:<span class="mxinfo" id="T2:U126">2</span></span>,<span class="var type1" id="S46T2U427">k</span>)</span> - <span class="mxinfo" id="T42:U128"><span class="var type1" id="S48T12U429">InertialPositionNew</span>(<span class="mxinfo" id="T39:U130"><span class="mxinfo" id="T2:U131">1</span>:<span class="mxinfo" id="T2:U132">2</span></span>,<span class="var type1" id="S46T2U433">k</span>)</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line">        <span class="comment">% 补偿误差</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line">        <span class="mxinfo" id="T42:U134"><span class="mxinfo" id="T42:U135"><span class="var type1" id="S48T12U437">InertialPositionNew</span>(<span class="mxinfo" id="T39:U137"><span class="mxinfo" id="T2:U138">1</span>:<span class="mxinfo" id="T2:U139">2</span></span>,<span class="var type1" id="S46T2U441">k</span>)</span> = <span class="mxinfo" id="T42:U141"><span class="mxinfo" id="T42:U142"><span class="var type1" id="S48T12U444">InertialPositionNew</span>(<span class="mxinfo" id="T39:U144"><span class="mxinfo" id="T2:U145">1</span>:<span class="mxinfo" id="T2:U146">2</span></span>,<span class="var type1" id="S46T2U448">k</span>)</span> + <span class="mxinfo" id="T42:U148"><span class="mxinfo" id="T42:U149"><span class="var type1" id="S53T67U451">InertialErr</span>(:,<span class="var type1" id="S46T2U453">k</span>)</span>*<span class="var type1" id="S35T2U454">compensateRate</span></span></span></span> ; </span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line">        <span class="mxinfo" id="T42:U153"><span class="mxinfo" id="T42:U154"><span class="var type1" id="S54T67U458">StepCompensate</span>(:,<span class="var type1" id="S46T2U460">k</span>)</span> = <span class="mxinfo" id="T42:U157"><span class="mxinfo" id="T42:U158"><span class="var type1" id="S53T67U463">InertialErr</span>(:,<span class="var type1" id="S46T2U465">k</span>)</span>*<span class="var type1" id="S35T2U466">compensateRate</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line">    <span class="mxinfo" id="T42:U162"><span class="mxinfo" id="T42:U163"><span class="var type1" id="S47T12U470">InertialPositionCompensate</span>(<span class="mxinfo" id="T39:U165"><span class="mxinfo" id="T2:U166">1</span>:<span class="mxinfo" id="T2:U167">2</span></span>,<span class="var type1" id="S46T2U474">k</span>)</span> = <span class="mxinfo" id="T42:U169"><span class="mxinfo" id="T42:U170"><span class="var type1" id="S48T12U477">InertialPositionNew</span>(<span class="mxinfo" id="T39:U172"><span class="mxinfo" id="T2:U173">1</span>:<span class="mxinfo" id="T2:U174">2</span></span>,<span class="var type1" id="S46T2U481">k</span>)</span> - <span class="mxinfo" id="T42:U176"><span class="var type1" id="S38T12U483">InertialPosition</span>(<span class="mxinfo" id="T39:U178"><span class="mxinfo" id="T2:U179">1</span>:<span class="mxinfo" id="T2:U180">2</span></span>,<span class="var type1" id="S46T2U487">k</span>)</span></span></span> ;  <span class="comment">% 累积位移补偿量</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,160" id="srcline160">160</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,161" id="srcline161">161</a></span><span class="line"><span class="comment">%% 通过 InertialPositionNew 计算 HipDisplacementNew</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,162" id="srcline162">162</a></span><span class="line"><span class="comment">% 将Head位置传到Hip，：保持头和head的相对位移</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,163" id="srcline163">163</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,164" id="srcline164">164</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S46T2U490">k</span>=<span class="var type1" id="S40T2U492">CalStartIN</span>:<span class="var type1" id="S41T2U493">CalEndIN</span>    </span></span>
<span class="srcline"><span class="lineno"><a href="1,165" id="srcline165">165</a></span><span class="line">    <span class="mxinfo" id="T42:U185"><span class="mxinfo" id="T42:U186"><span class="var type1" id="S49T12U497">HipDisplacementNew</span>( <span class="mxinfo" id="T39:U188"><span class="mxinfo" id="T2:U189">1</span>:<span class="mxinfo" id="T2:U190">2</span></span>,<span class="var type1" id="S46T2U501">k</span> )</span> = <span class="mxinfo" id="T42:U192"><span class="mxinfo" id="T42:U193"><span class="var type1" id="S37T12U504">HipDisplacement</span>(<span class="mxinfo" id="T39:U195"><span class="mxinfo" id="T2:U196">1</span>:<span class="mxinfo" id="T2:U197">2</span></span>,<span class="var type1" id="S46T2U508">k</span>)</span> + <span class="mxinfo" id="T42:U199"><span class="var type1" id="S47T12U510">InertialPositionCompensate</span>(<span class="mxinfo" id="T39:U201"><span class="mxinfo" id="T2:U202">1</span>:<span class="mxinfo" id="T2:U203">2</span></span>,<span class="var type1" id="S46T2U514">k</span>)</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,166" id="srcline166">166</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,167" id="srcline167">167</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,168" id="srcline168">168</a></span><span class="line"><span class="mxinfo" id="T12:U205"><span class="var type1" id="S33T12U517">InertialPositionCompensate_out</span> = <span class="var type1" id="S47T12U518">InertialPositionCompensate</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,169" id="srcline169">169</a></span><span class="line"><span class="mxinfo" id="T12:U208"><span class="var type1" id="S34T12U521">HipDisplacementNew_out</span> = <span class="var type1" id="S49T12U522">HipDisplacementNew</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,170" id="srcline170">170</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T14:U211"><span class="var type1" id="S42T2U526">IsOnLine</span>==<span class="mxinfo" id="T2:U213">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,171" id="srcline171">171</a></span><span class="line">    <span class="mxinfo" id="T43:U214"><span class="extrinsicFcn" id="F567N10:B530">DrawCompensate</span>( <span class="var type1" id="S53T67U531">InertialErr</span>,<span class="var type1" id="S54T67U532">StepCompensate</span>,<span class="var type1" id="S36T12U533">trackedMakerPosition_InertialTime</span>,<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,172" id="srcline172">172</a></span><span class="line"><span class="mxinfo" id="T43:U214">        <span class="var type1" id="S38T12U534">InertialPosition</span>,<span class="var type1" id="S48T12U535">InertialPositionNew</span>,<span class="var type1" id="S47T12U536">InertialPositionCompensate</span>,<span class="var type1" id="S35T2U537">compensateRate</span>,<span class="mxinfo" id="T2:U222"><span class="var type1" id="S43T2U538">N_BVH</span></span> )</span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,173" id="srcline173">173</a></span><span class="line"><span class="keyword"><span class="keyword">end</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,174" id="srcline174">174</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,175" id="srcline175">175</a></span><span class="line"><span class="comment">%% 视觉位置预处理</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,176" id="srcline176">176</a></span><span class="line"><span class="comment">% 1）将视觉数据转到惯性</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,177" id="srcline177">177</a></span><span class="line"></span></span>
</pre>
